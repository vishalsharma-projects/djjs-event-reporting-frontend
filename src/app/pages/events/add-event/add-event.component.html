<!-- PrimeNG Toast Component -->
<p-toast
  position="top-right"
  [baseZIndex]="12000"
  [showTransformOptions]="'translateX(100%)'"
  [hideTransformOptions]="'translateX(100%)'"
  [showTransitionOptions]="'300ms ease-out'"
  [hideTransitionOptions]="'300ms ease-in'"
  (onClose)="onToastClose($event)"
  (onClick)="onToastClick($event)">
</p-toast>

<section class="event-stepper">
  <!-- Page Title -->
  <div class="row">
    <div class="col-12">
      <div class="page-title-box d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <button class="btn btn-link text-decoration-none me-3" (click)="goBack()">
            <i class="fas fa-arrow-left"></i>
          </button>
          <h4 class="mb-0">{{ isEditing ? 'EDIT EVENT' : 'ADD EVENT' }}</h4>
        </div>
        <div class="d-flex align-items-center gap-2">
          <!-- Validation Toggle -->
          <!-- <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="validationToggle"
              [checked]="validationSettings.getSettings().enabled"
              (change)="validationSettings.toggleValidation()">
            <label class="form-check-label" for="validationToggle"
              [class.text-success]="validationSettings.getSettings().enabled"
              [class.text-muted]="!validationSettings.getSettings().enabled">
              <i class="fas" [ngClass]="validationSettings.getSettings().enabled ? 'fa-check-circle' : 'fa-times-circle'"></i>
              Validation {{ validationSettings.getSettings().enabled ? 'ON' : 'OFF' }}
            </label>
          </div> -->
          <button class="btn btn-outline-warning btn-sm" (click)="clearDraftAndStartFresh()" *ngIf="draftId">
            <i class="fas fa-eraser me-1"></i> Clear Data
          </button>
          <button class="btn btn-outline-danger btn-sm" (click)="deleteIncompleteEvent()" *ngIf="isEditing && eventId && eventStatus === 'incomplete'">
            <i class="fas fa-trash-alt me-1"></i> Delete Event
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Stepper Progress -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="stepper-progress">
        <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
          <div class="step-number">1</div>
          <div class="step-label">General Details</div>
        </div>
        <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
          <div class="step-number">2</div>
          <div class="step-label">Media & promotion</div>
        </div>
        <div class="step" [class.active]="currentStep === 3" [class.completed]="currentStep > 3">
          <div class="step-number">3</div>
          <div class="step-label">Special guests</div>
        </div>
        <div class="step" [class.active]="currentStep === 4">
          <div class="step-number">4</div>
          <div class="step-label">Volunteers</div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ================= STEP 1 : GENERAL DETAILS ================= -->
<div *ngIf="currentStep === 1">

  <form [formGroup]="generalDetailsForm">
    <div class="common-stepper">
      <h5 class="mb-3">Event details</h5>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">Type <span class="text-danger">*</span></label>
          <ng-select formControlName="eventType" 
            [items]="eventTypes"
            bindLabel="name"
            bindValue="name"
            [searchable]="true"
            [clearable]="true"
            placeholder="{{ loadingEventTypes ? 'Loading...' : 'Select Event Type' }}"
            [disabled]="loadingEventTypes"
            [ngClass]="{'is-invalid': isFieldInvalid('eventType')}">
          </ng-select>
          <div class="invalid-feedback" *ngIf="isFieldInvalid('eventType')">
            Event Type is required.
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Event category <span class="text-danger">*</span></label>
          <ng-select formControlName="eventCategory"
            [items]="filteredEventCategories"
            bindLabel="name"
            bindValue="name"
            [searchable]="true"
            [clearable]="true"
            [placeholder]="loadingEventCategories ? 'Loading...' : (filteredEventCategories.length === 0 ? 'Select Event Type first' : 'Select Category')"
            [disabled]="loadingEventCategories || filteredEventCategories.length === 0"
            [ngClass]="{'is-invalid': isFieldInvalid('eventCategory')}">
          </ng-select>
          <div class="invalid-feedback" *ngIf="isFieldInvalid('eventCategory')">
            Event Category is required.
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Event sub category</label>
          <ng-select formControlName="eventSubCategory"
            [items]="filteredEventSubCategories"
            bindLabel="name"
            bindValue="name"
            [searchable]="true"
            [clearable]="true"
            [placeholder]="loadingEventSubCategories ? 'Loading...' : (filteredEventSubCategories.length === 0 ? 'Select Event Category first' : 'Select Sub Category')"
            [disabled]="loadingEventSubCategories || filteredEventSubCategories.length === 0">
          </ng-select>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">Scale</label>
          <ng-select formControlName="scale"
            [items]="scales"
            [searchable]="true"
            [clearable]="true"
            placeholder="Select Scale">
          </ng-select>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Theme</label>
          <ng-select formControlName="theme"
            [items]="themes"
            bindLabel="name"
            bindValue="name"
            [searchable]="true"
            [clearable]="true"
            [placeholder]="loadingThemes ? 'Loading...' : 'Select Theme'"
            [disabled]="loadingThemes">
          </ng-select>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Language</label>
          <ng-select formControlName="language"
            [items]="languages"
            [searchable]="true"
            [clearable]="true"
            placeholder="Select Language">
          </ng-select>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">Duration <span class="text-danger">*</span></label>
          <div class="row g-2">
            <div class="col-6">
              <input type="date" class="form-control" placeholder="Start Date" formControlName="startDate"
                (change)="onStartDateChange()" autocomplete="off"
                [max]="getMaxStartDate()"
                [ngClass]="{'is-invalid': isFieldInvalid('duration') || isDateRangeInvalid()}">
            </div>
            <div class="col-6">
              <input type="date" class="form-control" placeholder="End Date" formControlName="endDate"
                (change)="onEndDateChange()" autocomplete="off"
                [min]="getMinEndDate()"
                [ngClass]="{'is-invalid': isFieldInvalid('duration') || isDateRangeInvalid()}">
            </div>
          </div>
          <input type="hidden" formControlName="duration">
          <small class="text-muted" *ngIf="getDurationDisplay()">{{ getDurationDisplay() }}</small>
          <div class="invalid-feedback d-block" *ngIf="isFieldInvalid('duration')">
            Duration is required. Please select start and end dates.
          </div>
          <div class="invalid-feedback d-block" *ngIf="isDateRangeInvalid() && !isFieldInvalid('duration')">
            End date cannot be before start date.
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Daily Start Time</label>
          <input type="time" class="form-control" formControlName="dailyStartTime"
            (change)="onDailyStartTimeChange()"
            [max]="getMaxDailyStartTime()"
            [ngClass]="{'is-invalid': isTimeRangeInvalid()}">
          <div class="invalid-feedback d-block" *ngIf="isTimeRangeInvalid()">
            Daily end time must be after daily start time.
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Daily End Time</label>
          <input type="time" class="form-control" formControlName="dailyEndTime"
            (change)="onDailyEndTimeChange()"
            [min]="getMinDailyEndTime()"
            [ngClass]="{'is-invalid': isTimeRangeInvalid()}">
          <div class="invalid-feedback d-block" *ngIf="isTimeRangeInvalid()">
            Daily end time must be after daily start time.
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Orator(s)</label>
          <ng-select formControlName="spiritualOrator"
            [items]="orators"
            bindLabel="name"
            bindValue="name"
            [multiple]="true"
            [searchable]="true"
            [clearable]="true"
            [closeOnSelect]="false"
            [placeholder]="loadingOrators ? 'Loading...' : 'Select Orator(s)'"
            [disabled]="loadingOrators">
          </ng-select>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Branch</label>
          <ng-select formControlName="branchId"
            [items]="branches"
            bindLabel="name"
            bindValue="id"
            [searchable]="true"
            [clearable]="true"
            [placeholder]="loadingBranches ? 'Loading...' : 'Select Branch'"
            [disabled]="loadingBranches">
          </ng-select>
        </div>
      </div>
    </div>
    <!-- Venue Section -->
    <div class="common-stepper">
      <h5 class="mb-3">Venue</h5>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">Country <span class="text-danger">*</span></label>
          <ng-select formControlName="country"
            [items]="countries"
            bindLabel="name"
            bindValue="name"
            [searchable]="true"
            [clearable]="true"
            placeholder="Select Country"
            [ngClass]="{'is-invalid': isFieldInvalid('country')}">
          </ng-select>
          <div class="invalid-feedback" *ngIf="isFieldInvalid('country')">
            Country is required.
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">State <span class="text-danger">*</span></label>
          <ng-select formControlName="state"
            [items]="filteredStates"
            bindLabel="name"
            bindValue="name"
            [searchable]="true"
            [clearable]="true"
            placeholder="Select State"
            [ngClass]="{'is-invalid': isFieldInvalid('state')}">
          </ng-select>
          <div class="invalid-feedback" *ngIf="isFieldInvalid('state')">
            State is required.
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">City <span class="text-danger">*</span></label>
          <ng-select formControlName="city"
            [items]="filteredCities"
            bindLabel="name"
            bindValue="name"
            [searchable]="true"
            [clearable]="true"
            [placeholder]="loadingCities ? 'Loading...' : (filteredCities.length === 0 ? 'Select State first' : 'Select City')"
            [disabled]="loadingCities || filteredCities.length === 0"
            [ngClass]="{'is-invalid': isFieldInvalid('city')}">
          </ng-select>
          <div class="invalid-feedback" *ngIf="isFieldInvalid('city')">
            City is required.
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">Pincode</label>
          <input type="text" class="form-control" formControlName="pincode" placeholder="Enter pincode">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Post office</label>
          <input type="text" class="form-control" formControlName="postOffice">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Police station</label>
          <input type="text" class="form-control" formControlName="policeStation">
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">Address type</label>
          <ng-select formControlName="addressType"
            [items]="addressTypes"
            [searchable]="true"
            [clearable]="true"
            placeholder="Select Address Type">
          </ng-select>
        </div>
        <div class="col-md-8 mb-3">
          <label class="form-label">Address <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="address"
            [ngClass]="{'is-invalid': isFieldInvalid('address')}">
          <div class="invalid-feedback" *ngIf="isFieldInvalid('address')">
            Address is required.
          </div>
        </div>
      </div>

      <!-- <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Prachar</label>
          <ng-select formControlName="prachar"
            [items]="pracharAreas"
            [multiple]="true"
            [searchable]="true"
            [clearable]="true"
            placeholder="Select Prachar Areas">
          </ng-select>
        </div>
      </div> -->
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">Area covered</label>
          <input type="text" class="form-control" formControlName="areaCovered" placeholder="0.00 Sq km">
        </div>
      </div>
      
    </div>
    <!-- Donations -->
    <!-- <div class="common-stepper">
      <h5 class="mt-4 mb-3">Donations</h5>

      <div class="row">
        <div class="col-md-3 mb-3">
          <label class="form-label">Donation type</label>
          <select class="form-select" formControlName="donationType">
            <option value="cash">Cash</option>
            <option value="in-kind">In-kind</option>
          </select>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">Amount</label>
          <input type="number" class="form-control" formControlName="amount" placeholder="Amount in Rupees">
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">In-kind type</label>
          <input type="text" class="form-control" formControlName="inKindType" placeholder="Rice 5kg, Bedsheet 2...">
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">Estimated material value</label>
          <input type="number" class="form-control" formControlName="materialValue" placeholder="Amount in Rupees">
        </div>
      </div>
</div> -->
    <!-- Donations -->
    <div class="common-stepper">
      <h5 class=" mb-3">Donations</h5>

      <!-- Dynamic Donation Entries -->
      <div *ngFor="let donation of donationTypes; let i = index" class="row mb-3">
        <!-- Donation Type -->
        <div class="col-md-3">
          <label class="form-label">Donation type</label>
          <ng-select [(ngModel)]="donation.type" [ngModelOptions]="{standalone: true}" (change)="onDonationTypeChange(i)"
            [items]="getDonationTypeOptions()"
            bindLabel="label"
            bindValue="value"
            [searchable]="true"
            [clearable]="false"
            placeholder="Select Donation Type">
          </ng-select>
        </div>

        <!-- Cash Amount Field (shown only for cash type) -->
        <div class="col-md-3" *ngIf="donation.type === 'cash'">
          <label class="form-label">Amount</label>
          <div class="input-group">
            <span class="input-group-text">₹</span>
            <input type="number" class="form-control" [(ngModel)]="donation.amount" [ngModelOptions]="{standalone: true}" placeholder="Amount in Rupees">
          </div>
        </div>

        <!-- In-kind Type Field (shown only for in-kind type) -->
        <div class="col-md-3" *ngIf="donation.type === 'in-kind'">
          <label class="form-label">In-kind type</label>
          <div class="tag-input-container">
            <div class="tags-display">
              <span *ngFor="let tag of donation.tags; let tagIndex = index" class="tag-item">
                {{ tag }}
                <button type="button" class="tag-remove" (click)="removeTag(i, tagIndex)">
                  <i class="fas fa-times"></i>
                </button>
              </span>
              <input type="text" class="tag-input" [(ngModel)]="donation.currentInput" [ngModelOptions]="{standalone: true}"
                (keydown)="onTagInputKeydown($event, i)" placeholder="Type and press Enter/Space">
            </div>
            
          </div>
        </div>

        <!-- Estimated Material Value Field (shown only for in-kind type) -->
        <div class="col-md-3" *ngIf="donation.type === 'in-kind'">
          <label class="form-label">Estimated material value</label>
          <div class="input-group">
            <span class="input-group-text">₹</span>
            <input type="number" class="form-control" [(ngModel)]="donation.materialValue" [ngModelOptions]="{standalone: true}"
              placeholder="Amount in Rupees">
          </div>
        </div>

        <!-- Delete Button -->
        <div class="col-md-3 d-flex align-items-end">
          <button type="button" class="btn btn-warning btn-xs" (click)="removeDonationType(i)"
            [disabled]="donationTypes.length === 1">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>

      <!-- Add Donation Type Button -->
      <div class="mt-3">
        <button type="button" class="btn btn-warning btn-sm" (click)="addDonationType()">
          + Add donation type
        </button>
      </div>
    </div>
    <!-- Beneficiaries -->
    <div class="common-stepper">
      <h5 class="mb-3">Beneficiaries (0)</h5>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">Men</label>
          <input type="number" class="form-control" formControlName="beneficiariesMen">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Women</label>
          <input type="number" class="form-control" formControlName="beneficiariesWomen">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Children</label>
          <input type="number" class="form-control" formControlName="beneficiariesChildren">
        </div>
      </div>
    </div>
    <!-- Initiations -->
    <div class="common-stepper">
      <h5 class="mb-3">Initiation (0)</h5>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">Men</label>
          <input type="number" class="form-control" formControlName="initiationMen">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Women</label>
          <input type="number" class="form-control" formControlName="initiationWomen">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Children</label>
          <input type="number" class="form-control" formControlName="initiationChildren">
        </div>
      </div>
    </div>
    <!-- Navigation + Autosave -->
    <div class="d-flex justify-content-between align-items-center mt-4 common-stepper">
      <!-- Autosave Message -->
      <div class="text-success small">
        <i class="bi bi-check-circle"></i> All changes are autosaved
      </div>

      <!-- Next Button -->
      <button type="button" class="btn btn-primary" (click)="nextStep()">
        Next
      </button>
    </div>
  </form>
</div>


<!-- ================= STEP 2 : MEDIA & PROMOTION ================= -->
<!-- Step 2: Media & Promotion -->
<div *ngIf="currentStep === 2">
  <!-- Button to open Media Promotion Modal - Top Right Corner -->
  <div class="d-flex justify-content-end mb-3">
    <button type="button" class="btn btn-warning" (click)="openMediaPromotionModal()">
      <i class="fas fa-plus me-2"></i>Add Media Details
    </button>
  </div>
  
  <!-- Event Media Table -->
  <div class="common-stepper">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
      <h6 class="mb-0">List of Event Media ({{ filteredEventMediaList.length }})</h6>
      <div class="d-flex gap-2 align-items-center">
        <!-- Column Visibility Manager -->
        <div class="column-visibility-manager" (click)="$event.stopPropagation()">
          <button type="button" class="btn btn-outline-info btn-sm" (click)="toggleEventMediaColumnVisibilityMenu()">
            <i class="pi pi-eye me-1"></i>
            Columns
            <span class="badge bg-info ms-1" *ngIf="getHiddenColumnsCount(EVENT_MEDIA_CONFIG) > 0">{{ getHiddenColumnsCount(EVENT_MEDIA_CONFIG) }}</span>
          </button>
          <div class="column-visibility-dropdown" [class.show]="isColumnVisibilityMenuOpen(EVENT_MEDIA_CONFIG)">
            <div class="dropdown-header">
              <h6>Column Visibility</h6>
              <button type="button" class="btn btn-link p-0" (click)="closeEventMediaColumnVisibilityMenu()">
                <i class="pi pi-times"></i>
              </button>
            </div>
            <div class="dropdown-body">
              <div class="column-visibility-item" *ngFor="let column of getAllEventMediaColumns()">
                <label class="d-flex align-items-center">
                  <input type="checkbox" [checked]="!isEventMediaColumnHidden(column)" (change)="toggleEventMediaColumnVisibility(column)" />
                  <span class="ms-2">{{ getEventMediaColumnDisplayName(column) }}</span>
                </label>
              </div>
            </div>
            <div class="dropdown-footer">
              <button type="button" class="btn btn-sm btn-outline-secondary" (click)="showAllEventMediaColumns()" [disabled]="getHiddenColumnsCount(EVENT_MEDIA_CONFIG) === 0">
                Show All
              </button>
            </div>
          </div>
        </div>
      <div class="search-box" style="width: 300px;">
        <input type="text" class="form-control form-control-sm" placeholder="Search media..." 
          [(ngModel)]="eventMediaSearchTerm" />
        </div>
      </div>
    </div>
    <div class="event-table-container mt-3">
      <p-table [value]="filteredEventMediaList" 
        [paginator]="true"
        [rows]="eventMediaPagination.rows"
        [first]="eventMediaPagination.first"
        [rowsPerPageOptions]="eventMediaPagination.rowsPerPageOptions"
        [tableStyle]="{ 'min-width': '100%' }">
        <ng-template pTemplate="header">
          <tr>
            <ng-container *ngFor="let column of getAllEventMediaColumns()">
              <th *ngIf="column === 'actions' && !isEventMediaColumnHidden('actions')" 
                  style="width: 120px;"
                  draggable="true"
                  (dragstart)="onEventMediaColumnDragStart($event, 'actions')"
                  (dragend)="onEventMediaColumnDragEnd($event)"
                  (dragover)="onEventMediaColumnDragOver($event, 'actions')"
                  (dragleave)="onEventMediaColumnDragLeave($event)"
                  (drop)="onEventMediaColumnDrop($event, 'actions')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Actions</span>
                </div>
              </th>
              <th *ngIf="column === 'type' && !isEventMediaColumnHidden('type')"
                  draggable="true"
                  (dragstart)="onEventMediaColumnDragStart($event, 'type')"
                  (dragend)="onEventMediaColumnDragEnd($event)"
                  (dragover)="onEventMediaColumnDragOver($event, 'type')"
                  (dragleave)="onEventMediaColumnDragLeave($event)"
                  (drop)="onEventMediaColumnDrop($event, 'type')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Type</span>
                </div>
              </th>
              <th *ngIf="column === 'companyName' && !isEventMediaColumnHidden('companyName')"
                  draggable="true"
                  (dragstart)="onEventMediaColumnDragStart($event, 'companyName')"
                  (dragend)="onEventMediaColumnDragEnd($event)"
                  (dragover)="onEventMediaColumnDragOver($event, 'companyName')"
                  (dragleave)="onEventMediaColumnDragLeave($event)"
                  (drop)="onEventMediaColumnDrop($event, 'companyName')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Company Name</span>
                </div>
              </th>
              <th *ngIf="column === 'companyEmail' && !isEventMediaColumnHidden('companyEmail')"
                  draggable="true"
                  (dragstart)="onEventMediaColumnDragStart($event, 'companyEmail')"
                  (dragend)="onEventMediaColumnDragEnd($event)"
                  (dragover)="onEventMediaColumnDragOver($event, 'companyEmail')"
                  (dragleave)="onEventMediaColumnDragLeave($event)"
                  (drop)="onEventMediaColumnDrop($event, 'companyEmail')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Company Email</span>
                </div>
              </th>
              <th *ngIf="column === 'companyWebsite' && !isEventMediaColumnHidden('companyWebsite')"
                  draggable="true"
                  (dragstart)="onEventMediaColumnDragStart($event, 'companyWebsite')"
                  (dragend)="onEventMediaColumnDragEnd($event)"
                  (dragover)="onEventMediaColumnDragOver($event, 'companyWebsite')"
                  (dragleave)="onEventMediaColumnDragLeave($event)"
                  (drop)="onEventMediaColumnDrop($event, 'companyWebsite')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Company Website</span>
                </div>
              </th>
              <th *ngIf="column === 'gender' && !isEventMediaColumnHidden('gender')"
                  draggable="true"
                  (dragstart)="onEventMediaColumnDragStart($event, 'gender')"
                  (dragend)="onEventMediaColumnDragEnd($event)"
                  (dragover)="onEventMediaColumnDragOver($event, 'gender')"
                  (dragleave)="onEventMediaColumnDragLeave($event)"
                  (drop)="onEventMediaColumnDrop($event, 'gender')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Gender</span>
                </div>
              </th>
              <th *ngIf="column === 'designation' && !isEventMediaColumnHidden('designation')"
                  draggable="true"
                  (dragstart)="onEventMediaColumnDragStart($event, 'designation')"
                  (dragend)="onEventMediaColumnDragEnd($event)"
                  (dragover)="onEventMediaColumnDragOver($event, 'designation')"
                  (dragleave)="onEventMediaColumnDragLeave($event)"
                  (drop)="onEventMediaColumnDrop($event, 'designation')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Designation</span>
                </div>
              </th>
              <th *ngIf="column === 'contact' && !isEventMediaColumnHidden('contact')"
                  draggable="true"
                  (dragstart)="onEventMediaColumnDragStart($event, 'contact')"
                  (dragend)="onEventMediaColumnDragEnd($event)"
                  (dragover)="onEventMediaColumnDragOver($event, 'contact')"
                  (dragleave)="onEventMediaColumnDragLeave($event)"
                  (drop)="onEventMediaColumnDrop($event, 'contact')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Contact</span>
                </div>
              </th>
            </ng-container>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-media let-i="rowIndex">
          <tr>
            <ng-container *ngFor="let column of getAllEventMediaColumns()">
              <td *ngIf="column === 'actions' && !isEventMediaColumnHidden('actions')">
              <div class="d-flex gap-1">
                <button class="btn btn-primary btn-sm" (click)="editEventMedia(i)" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-danger btn-sm" (click)="removeEventMedia(i)" title="Remove">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
              <td *ngIf="column === 'type' && !isEventMediaColumnHidden('type')">{{ media.mediaCoverageType }}</td>
              <td *ngIf="column === 'companyName' && !isEventMediaColumnHidden('companyName')">{{ media.companyName }}</td>
              <td *ngIf="column === 'companyEmail' && !isEventMediaColumnHidden('companyEmail')">
                <span *ngIf="media.companyEmail">{{ media.companyEmail }}</span>
                <span *ngIf="!media.companyEmail" class="text-muted">-</span>
              </td>
              <td *ngIf="column === 'companyWebsite' && !isEventMediaColumnHidden('companyWebsite')">{{ media.companyWebsite }}</td>
              <td *ngIf="column === 'gender' && !isEventMediaColumnHidden('gender')">{{ media.gender }}</td>
              <td *ngIf="column === 'designation' && !isEventMediaColumnHidden('designation')">{{ media.designation }}</td>
              <td *ngIf="column === 'contact' && !isEventMediaColumnHidden('contact')">{{ media.contact }}</td>
            </ng-container>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td [attr.colspan]="getEventMediaVisibleColumnCount()" class="text-center text-muted">No event media added yet. Click "Add Media Details" to add.</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Promotional Material Used -->
  <div class="common-stepper mt-4">
    <h5 class="mb-3">Promotional Material Used</h5>
    <div class="d-flex justify-content-end mb-3">
      <button type="button" class="btn btn-warning" (click)="openPromotionalMaterialModal()">
        <i class="fas fa-plus me-2"></i>Add Material Type
      </button>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
      <h6 class="mb-0">List of Promotional Materials ({{ getFilteredPromotionalMaterials().length }})</h6>
      <div class="d-flex gap-2 align-items-center">
        <!-- Column Visibility Manager -->
        <div class="column-visibility-manager" (click)="$event.stopPropagation()">
          <button type="button" class="btn btn-outline-info btn-sm" (click)="togglePromotionalMaterialColumnVisibilityMenu()">
            <i class="pi pi-eye me-1"></i>
            Columns
            <span class="badge bg-info ms-1" *ngIf="getHiddenColumnsCount(PROMOTIONAL_MATERIAL_CONFIG) > 0">{{ getHiddenColumnsCount(PROMOTIONAL_MATERIAL_CONFIG) }}</span>
          </button>
          <div class="column-visibility-dropdown" [class.show]="isColumnVisibilityMenuOpen(PROMOTIONAL_MATERIAL_CONFIG)">
            <div class="dropdown-header">
              <h6>Column Visibility</h6>
              <button type="button" class="btn btn-link p-0" (click)="closePromotionalMaterialColumnVisibilityMenu()">
                <i class="pi pi-times"></i>
              </button>
            </div>
            <div class="dropdown-body">
              <div class="column-visibility-item" *ngFor="let column of getAllPromotionalMaterialColumns()">
                <label class="d-flex align-items-center">
                  <input type="checkbox" [checked]="!isPromotionalMaterialColumnHidden(column)" (change)="togglePromotionalMaterialColumnVisibility(column)" />
                  <span class="ms-2">{{ getPromotionalMaterialColumnDisplayName(column) }}</span>
                </label>
              </div>
            </div>
            <div class="dropdown-footer">
              <button type="button" class="btn btn-sm btn-outline-secondary" (click)="showAllPromotionalMaterialColumns()" [disabled]="getHiddenColumnsCount(PROMOTIONAL_MATERIAL_CONFIG) === 0">
                Show All
              </button>
            </div>
          </div>
        </div>
      <div class="search-box" style="width: 300px;">
        <input type="text" class="form-control form-control-sm" placeholder="Search materials..." 
          [(ngModel)]="promotionalMaterialSearchTerm" />
        </div>
      </div>
    </div>
    <div class="event-table-container mt-3">
      <p-table [value]="getFilteredPromotionalMaterials()" 
        [paginator]="true"
        [rows]="promotionalMaterialPagination.rows"
        [first]="promotionalMaterialPagination.first"
        [rowsPerPageOptions]="promotionalMaterialPagination.rowsPerPageOptions"
        [tableStyle]="{ 'min-width': '100%' }">
        <ng-template pTemplate="header">
          <tr>
            <ng-container *ngFor="let column of getAllPromotionalMaterialColumns()">
              <th *ngIf="column === 'actions' && !isPromotionalMaterialColumnHidden('actions')" 
                  style="width: 80px;"
                  draggable="true"
                  (dragstart)="onPromotionalMaterialColumnDragStart($event, 'actions')"
                  (dragend)="onPromotionalMaterialColumnDragEnd($event)"
                  (dragover)="onPromotionalMaterialColumnDragOver($event, 'actions')"
                  (dragleave)="onPromotionalMaterialColumnDragLeave($event)"
                  (drop)="onPromotionalMaterialColumnDrop($event, 'actions')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Actions</span>
                </div>
              </th>
              <th *ngIf="column === 'materialType' && !isPromotionalMaterialColumnHidden('materialType')"
                  draggable="true"
                  (dragstart)="onPromotionalMaterialColumnDragStart($event, 'materialType')"
                  (dragend)="onPromotionalMaterialColumnDragEnd($event)"
                  (dragover)="onPromotionalMaterialColumnDragOver($event, 'materialType')"
                  (dragleave)="onPromotionalMaterialColumnDragLeave($event)"
                  (drop)="onPromotionalMaterialColumnDrop($event, 'materialType')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Material Type</span>
                </div>
              </th>
              <th *ngIf="column === 'quantity' && !isPromotionalMaterialColumnHidden('quantity')"
                  draggable="true"
                  (dragstart)="onPromotionalMaterialColumnDragStart($event, 'quantity')"
                  (dragend)="onPromotionalMaterialColumnDragEnd($event)"
                  (dragover)="onPromotionalMaterialColumnDragOver($event, 'quantity')"
                  (dragleave)="onPromotionalMaterialColumnDragLeave($event)"
                  (drop)="onPromotionalMaterialColumnDrop($event, 'quantity')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Quantity</span>
                </div>
              </th>
              <th *ngIf="column === 'size' && !isPromotionalMaterialColumnHidden('size')"
                  draggable="true"
                  (dragstart)="onPromotionalMaterialColumnDragStart($event, 'size')"
                  (dragend)="onPromotionalMaterialColumnDragEnd($event)"
                  (dragover)="onPromotionalMaterialColumnDragOver($event, 'size')"
                  (dragleave)="onPromotionalMaterialColumnDragLeave($event)"
                  (drop)="onPromotionalMaterialColumnDrop($event, 'size')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Size</span>
                </div>
              </th>
              <th *ngIf="column === 'customDimension' && !isPromotionalMaterialColumnHidden('customDimension')"
                  draggable="true"
                  (dragstart)="onPromotionalMaterialColumnDragStart($event, 'customDimension')"
                  (dragend)="onPromotionalMaterialColumnDragEnd($event)"
                  (dragover)="onPromotionalMaterialColumnDragOver($event, 'customDimension')"
                  (dragleave)="onPromotionalMaterialColumnDragLeave($event)"
                  (drop)="onPromotionalMaterialColumnDrop($event, 'customDimension')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Custom Dimension</span>
                </div>
              </th>
            </ng-container>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-material let-i="rowIndex">
          <tr>
            <ng-container *ngFor="let column of getAllPromotionalMaterialColumns()">
              <td *ngIf="column === 'actions' && !isPromotionalMaterialColumnHidden('actions')">
              <button class="btn btn-danger btn-sm" (click)="removeMaterialTypeByValidIndex(i)" title="Remove">
                <i class="fas fa-trash"></i>
              </button>
            </td>
              <td *ngIf="column === 'materialType' && !isPromotionalMaterialColumnHidden('materialType')">{{ material.materialType }}</td>
              <td *ngIf="column === 'quantity' && !isPromotionalMaterialColumnHidden('quantity')">{{ material.quantity }}</td>
              <td *ngIf="column === 'size' && !isPromotionalMaterialColumnHidden('size')">{{ material.size }}</td>
              <td *ngIf="column === 'customDimension' && !isPromotionalMaterialColumnHidden('customDimension')">
                <span *ngIf="material.customHeight && material.customWidth">
                  {{ material.customHeight }} {{ material.customHeightUnit || 'inch' }} x {{ material.customWidth }} {{ material.customWidthUnit || 'inch' }}
                </span>
                <span *ngIf="!material.customHeight || !material.customWidth" class="text-muted">-</span>
              </td>
            </ng-container>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td [attr.colspan]="getPromotionalMaterialVisibleColumnCount()" class="text-center text-muted">No promotional materials added yet. Click "Add Material Type" to add.</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Media and Documentation -->
  <div class="common-stepper mt-4">
    <h5 class="mb-3">Media and Documentation</h5>
    <div class="row mb-3">
      <div class="col-12">
        <label class="form-label">Media Files (Photos, Videos, Documents)</label>
        <input type="file" class="form-control file-input-custom" (change)="onFileInputChange($event, 'allFiles')" 
          accept="image/*,video/*,.pdf,.doc,.docx" multiple />
        <small class="form-text text-muted">Select photos, videos, or documents to upload</small>
      </div>
    </div>
    <h6 class="mt-4">Uploaded Files ({{ fileMetadata.allFiles?.length || 0 }})</h6>
    <div class="uploaded-files-list mt-3" *ngIf="fileMetadata.allFiles && fileMetadata.allFiles.length > 0">
      <div class="d-flex flex-wrap gap-2">
        <div *ngFor="let file of fileMetadata.allFiles; let i = index" class="uploaded-file-item">
          <span class="file-name">{{ file.name }}</span>
          <button type="button" class="btn-remove-file" (click)="removeFile('allFiles', i)" title="Remove file">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </div>
    <div *ngIf="!fileMetadata.allFiles || fileMetadata.allFiles.length === 0" class="text-center text-muted mt-3 p-3">
      No files uploaded yet. Select files above to upload.
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-4 common-stepper">
    <div class="text-success small">
      <i class="bi bi-check-circle"></i> All changes are autosaved
    </div>
    <div>
      <button class="btn btn-warning me-2" (click)="previousStep()">Back</button>
      <button class="btn btn-primary" (click)="nextStep()">Next</button>
    </div>
  </div>
</div>


<!-- ================= STEP 3 : SPECIAL GUESTS ================= -->
<!-- Step 3: Special Guests -->
<div *ngIf="currentStep === 3">
  <!-- Button to open Special Guests Modal - Top Right Corner -->
  <div class="d-flex justify-content-end mb-3">
    <button type="button" class="btn btn-warning" (click)="openSpecialGuestsModal()">
      <i class="fas fa-plus me-2"></i>Add Special Guest
    </button>
  </div>

  <!-- Special Guest Table -->
  <div class="common-stepper">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
      <h6 class="mb-0">List of Special Guests ({{ filteredSpecialGuestList.length }})</h6>
      <div class="d-flex gap-2 align-items-center">
        <!-- Column Visibility Manager -->
        <div class="column-visibility-manager" (click)="$event.stopPropagation()">
          <button type="button" class="btn btn-outline-info btn-sm" (click)="toggleSpecialGuestsColumnVisibilityMenu()">
            <i class="pi pi-eye me-1"></i>
            Columns
            <span class="badge bg-info ms-1" *ngIf="getHiddenColumnsCount(SPECIAL_GUESTS_CONFIG) > 0">{{ getHiddenColumnsCount(SPECIAL_GUESTS_CONFIG) }}</span>
          </button>
          <div class="column-visibility-dropdown" [class.show]="isColumnVisibilityMenuOpen(SPECIAL_GUESTS_CONFIG)">
            <div class="dropdown-header">
              <h6>Column Visibility</h6>
              <button type="button" class="btn btn-link p-0" (click)="closeSpecialGuestsColumnVisibilityMenu()">
                <i class="pi pi-times"></i>
              </button>
            </div>
            <div class="dropdown-body">
              <div class="column-visibility-item" *ngFor="let column of getAllSpecialGuestsColumns()">
                <label class="d-flex align-items-center">
                  <input type="checkbox" [checked]="!isSpecialGuestsColumnHidden(column)" (change)="toggleSpecialGuestsColumnVisibility(column)" />
                  <span class="ms-2">{{ getSpecialGuestsColumnDisplayName(column) }}</span>
                </label>
              </div>
            </div>
            <div class="dropdown-footer">
              <button type="button" class="btn btn-sm btn-outline-secondary" (click)="showAllSpecialGuestsColumns()" [disabled]="getHiddenColumnsCount(SPECIAL_GUESTS_CONFIG) === 0">
                Show All
              </button>
            </div>
          </div>
        </div>
      <div class="search-box" style="width: 300px;">
        <input type="text" class="form-control form-control-sm" placeholder="Search guests..." 
          [(ngModel)]="specialGuestSearchTerm" />
        </div>
      </div>
    </div>
    <div class="event-table-container mt-3">
      <p-table [value]="filteredSpecialGuestList" 
        [paginator]="true"
        [rows]="specialGuestPagination.rows"
        [first]="specialGuestPagination.first"
        [rowsPerPageOptions]="specialGuestPagination.rowsPerPageOptions"
        [tableStyle]="{ 'min-width': '100%' }">
        <ng-template pTemplate="header">
          <tr>
            <ng-container *ngFor="let column of getAllSpecialGuestsColumns()">
              <th *ngIf="column === 'actions' && !isSpecialGuestsColumnHidden('actions')" 
                  style="width: 120px;"
                  draggable="true"
                  (dragstart)="onSpecialGuestsColumnDragStart($event, 'actions')"
                  (dragend)="onSpecialGuestsColumnDragEnd($event)"
                  (dragover)="onSpecialGuestsColumnDragOver($event, 'actions')"
                  (dragleave)="onSpecialGuestsColumnDragLeave($event)"
                  (drop)="onSpecialGuestsColumnDrop($event, 'actions')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Actions</span>
                </div>
              </th>
              <th *ngIf="column === 'name' && !isSpecialGuestsColumnHidden('name')"
                  draggable="true"
                  (dragstart)="onSpecialGuestsColumnDragStart($event, 'name')"
                  (dragend)="onSpecialGuestsColumnDragEnd($event)"
                  (dragover)="onSpecialGuestsColumnDragOver($event, 'name')"
                  (dragleave)="onSpecialGuestsColumnDragLeave($event)"
                  (drop)="onSpecialGuestsColumnDrop($event, 'name')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Name (Phone no.)</span>
                </div>
              </th>
              <th *ngIf="column === 'gender' && !isSpecialGuestsColumnHidden('gender')"
                  draggable="true"
                  (dragstart)="onSpecialGuestsColumnDragStart($event, 'gender')"
                  (dragend)="onSpecialGuestsColumnDragEnd($event)"
                  (dragover)="onSpecialGuestsColumnDragOver($event, 'gender')"
                  (dragleave)="onSpecialGuestsColumnDragLeave($event)"
                  (drop)="onSpecialGuestsColumnDrop($event, 'gender')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Gender</span>
                </div>
              </th>
              <th *ngIf="column === 'designation' && !isSpecialGuestsColumnHidden('designation')"
                  draggable="true"
                  (dragstart)="onSpecialGuestsColumnDragStart($event, 'designation')"
                  (dragend)="onSpecialGuestsColumnDragEnd($event)"
                  (dragover)="onSpecialGuestsColumnDragOver($event, 'designation')"
                  (dragleave)="onSpecialGuestsColumnDragLeave($event)"
                  (drop)="onSpecialGuestsColumnDrop($event, 'designation')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Designation</span>
                </div>
              </th>
              <th *ngIf="column === 'organization' && !isSpecialGuestsColumnHidden('organization')"
                  draggable="true"
                  (dragstart)="onSpecialGuestsColumnDragStart($event, 'organization')"
                  (dragend)="onSpecialGuestsColumnDragEnd($event)"
                  (dragover)="onSpecialGuestsColumnDragOver($event, 'organization')"
                  (dragleave)="onSpecialGuestsColumnDragLeave($event)"
                  (drop)="onSpecialGuestsColumnDrop($event, 'organization')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Organization</span>
                </div>
              </th>
              <th *ngIf="column === 'email' && !isSpecialGuestsColumnHidden('email')"
                  draggable="true"
                  (dragstart)="onSpecialGuestsColumnDragStart($event, 'email')"
                  (dragend)="onSpecialGuestsColumnDragEnd($event)"
                  (dragover)="onSpecialGuestsColumnDragOver($event, 'email')"
                  (dragleave)="onSpecialGuestsColumnDragLeave($event)"
                  (drop)="onSpecialGuestsColumnDrop($event, 'email')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Email</span>
                </div>
              </th>
              <th *ngIf="column === 'cityState' && !isSpecialGuestsColumnHidden('cityState')"
                  draggable="true"
                  (dragstart)="onSpecialGuestsColumnDragStart($event, 'cityState')"
                  (dragend)="onSpecialGuestsColumnDragEnd($event)"
                  (dragover)="onSpecialGuestsColumnDragOver($event, 'cityState')"
                  (dragleave)="onSpecialGuestsColumnDragLeave($event)"
                  (drop)="onSpecialGuestsColumnDrop($event, 'cityState')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>City, State</span>
                </div>
              </th>
              <th *ngIf="column === 'personalNumber' && !isSpecialGuestsColumnHidden('personalNumber')"
                  draggable="true"
                  (dragstart)="onSpecialGuestsColumnDragStart($event, 'personalNumber')"
                  (dragend)="onSpecialGuestsColumnDragEnd($event)"
                  (dragover)="onSpecialGuestsColumnDragOver($event, 'personalNumber')"
                  (dragleave)="onSpecialGuestsColumnDragLeave($event)"
                  (drop)="onSpecialGuestsColumnDrop($event, 'personalNumber')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Personal no.</span>
                </div>
              </th>
              <th *ngIf="column === 'contactPerson' && !isSpecialGuestsColumnHidden('contactPerson')"
                  draggable="true"
                  (dragstart)="onSpecialGuestsColumnDragStart($event, 'contactPerson')"
                  (dragend)="onSpecialGuestsColumnDragEnd($event)"
                  (dragover)="onSpecialGuestsColumnDragOver($event, 'contactPerson')"
                  (dragleave)="onSpecialGuestsColumnDragLeave($event)"
                  (drop)="onSpecialGuestsColumnDrop($event, 'contactPerson')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Contact Person (Phone no.)</span>
                </div>
              </th>
              <th *ngIf="column === 'referencePerson' && !isSpecialGuestsColumnHidden('referencePerson')"
                  draggable="true"
                  (dragstart)="onSpecialGuestsColumnDragStart($event, 'referencePerson')"
                  (dragend)="onSpecialGuestsColumnDragEnd($event)"
                  (dragover)="onSpecialGuestsColumnDragOver($event, 'referencePerson')"
                  (dragleave)="onSpecialGuestsColumnDragLeave($event)"
                  (drop)="onSpecialGuestsColumnDrop($event, 'referencePerson')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Reference Person (Phone no.)</span>
                </div>
              </th>
            </ng-container>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-guest let-i="rowIndex">
          <tr>
            <ng-container *ngFor="let column of getAllSpecialGuestsColumns()">
              <td *ngIf="column === 'actions' && !isSpecialGuestsColumnHidden('actions')">
              <div class="d-flex gap-1">
                <button class="btn btn-primary btn-sm" (click)="editSpecialGuest(i)" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-danger btn-sm" (click)="removeSpecialGuest(i)" title="Remove">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
              <td *ngIf="column === 'name' && !isSpecialGuestsColumnHidden('name')">{{ guest.firstName }} {{ guest.lastName }} ({{ guest.personalNumber }})</td>
              <td *ngIf="column === 'gender' && !isSpecialGuestsColumnHidden('gender')">{{ guest.gender }}</td>
              <td *ngIf="column === 'designation' && !isSpecialGuestsColumnHidden('designation')">{{ guest.designation }}</td>
              <td *ngIf="column === 'organization' && !isSpecialGuestsColumnHidden('organization')">{{ guest.organization }}</td>
              <td *ngIf="column === 'email' && !isSpecialGuestsColumnHidden('email')">{{ guest.email }}</td>
              <td *ngIf="column === 'cityState' && !isSpecialGuestsColumnHidden('cityState')">{{ guest.city }}, {{ guest.state }}</td>
              <td *ngIf="column === 'personalNumber' && !isSpecialGuestsColumnHidden('personalNumber')">{{ guest.personalNumber }}</td>
              <td *ngIf="column === 'contactPerson' && !isSpecialGuestsColumnHidden('contactPerson')">{{ guest.contactPerson }} ({{ guest.contactPersonNumber }})</td>
              <td *ngIf="column === 'referencePerson' && !isSpecialGuestsColumnHidden('referencePerson')">{{ guest.referencePersonName }} ({{ guest.referenceVolunteerId }})</td>
            </ng-container>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td [attr.colspan]="getSpecialGuestsVisibleColumnCount()" class="text-center text-muted">No special guests added yet. Click "Add Special Guest" to add.</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-4 common-stepper">
    <div class="text-success small">
      <i class="bi bi-check-circle"></i> All changes are autosaved
    </div>
    <div>
      <button class="btn btn-warning me-2" (click)="previousStep()">Back</button>
      <button class="btn btn-primary" (click)="nextStep()">Next</button>
    </div>
  </div>
</div>


<!-- ================= STEP 4 : VOLUNTEERS ================= -->
<!-- Step 4: Volunteers -->
<div *ngIf="currentStep === 4">
  <!-- Button to open Volunteers Modal - Top Right Corner -->
  <div class="d-flex justify-content-end mb-3">
    <button type="button" class="btn btn-warning" (click)="openVolunteersModal()">
      <i class="fas fa-plus me-2"></i>Add Volunteer
    </button>
  </div>

  <!-- Volunteer List Table -->
  <div class="common-stepper">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
      <h6 class="mb-0">List of Volunteers ({{ filteredVolunteerList.length }})</h6>
      <div class="d-flex gap-2 align-items-center">
        <!-- Column Visibility Manager -->
        <div class="column-visibility-manager" (click)="$event.stopPropagation()">
          <button type="button" class="btn btn-outline-info btn-sm" (click)="toggleVolunteersColumnVisibilityMenu()">
            <i class="pi pi-eye me-1"></i>
            Columns
            <span class="badge bg-info ms-1" *ngIf="getHiddenColumnsCount(VOLUNTEERS_CONFIG) > 0">{{ getHiddenColumnsCount(VOLUNTEERS_CONFIG) }}</span>
          </button>
          <div class="column-visibility-dropdown" [class.show]="isColumnVisibilityMenuOpen(VOLUNTEERS_CONFIG)">
            <div class="dropdown-header">
              <h6>Column Visibility</h6>
              <button type="button" class="btn btn-link p-0" (click)="closeVolunteersColumnVisibilityMenu()">
                <i class="pi pi-times"></i>
              </button>
            </div>
            <div class="dropdown-body">
              <div class="column-visibility-item" *ngFor="let column of getAllVolunteersColumns()">
                <label class="d-flex align-items-center">
                  <input type="checkbox" [checked]="!isVolunteersColumnHidden(column)" (change)="toggleVolunteersColumnVisibility(column)" />
                  <span class="ms-2">{{ getVolunteersColumnDisplayName(column) }}</span>
                </label>
              </div>
            </div>
            <div class="dropdown-footer">
              <button type="button" class="btn btn-sm btn-outline-secondary" (click)="showAllVolunteersColumns()" [disabled]="getHiddenColumnsCount(VOLUNTEERS_CONFIG) === 0">
                Show All
              </button>
            </div>
          </div>
        </div>
      <div class="search-box" style="width: 300px;">
        <input type="text" class="form-control form-control-sm" placeholder="Search volunteers..." 
          [(ngModel)]="volunteerSearchTerm" />
        </div>
      </div>
    </div>
    <div class="event-table-container mt-3">
      <p-table [value]="filteredVolunteerList" 
        [paginator]="true"
        [rows]="volunteerPagination.rows"
        [first]="volunteerPagination.first"
        [rowsPerPageOptions]="volunteerPagination.rowsPerPageOptions"
        [tableStyle]="{ 'min-width': '100%' }">
        <ng-template pTemplate="header">
          <tr>
            <ng-container *ngFor="let column of getAllVolunteersColumns()">
              <th *ngIf="column === 'actions' && !isVolunteersColumnHidden('actions')" 
                  style="width: 120px;"
                  draggable="true"
                  (dragstart)="onVolunteersColumnDragStart($event, 'actions')"
                  (dragend)="onVolunteersColumnDragEnd($event)"
                  (dragover)="onVolunteersColumnDragOver($event, 'actions')"
                  (dragleave)="onVolunteersColumnDragLeave($event)"
                  (drop)="onVolunteersColumnDrop($event, 'actions')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Actions</span>
                </div>
              </th>
              <th *ngIf="column === 'name' && !isVolunteersColumnHidden('name')"
                  draggable="true"
                  (dragstart)="onVolunteersColumnDragStart($event, 'name')"
                  (dragend)="onVolunteersColumnDragEnd($event)"
                  (dragover)="onVolunteersColumnDragOver($event, 'name')"
                  (dragleave)="onVolunteersColumnDragLeave($event)"
                  (drop)="onVolunteersColumnDrop($event, 'name')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Name</span>
                </div>
              </th>
              <th *ngIf="column === 'contact' && !isVolunteersColumnHidden('contact')"
                  draggable="true"
                  (dragstart)="onVolunteersColumnDragStart($event, 'contact')"
                  (dragend)="onVolunteersColumnDragEnd($event)"
                  (dragover)="onVolunteersColumnDragOver($event, 'contact')"
                  (dragleave)="onVolunteersColumnDragLeave($event)"
                  (drop)="onVolunteersColumnDrop($event, 'contact')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Contact no.</span>
                </div>
              </th>
              <th *ngIf="column === 'days' && !isVolunteersColumnHidden('days')"
                  draggable="true"
                  (dragstart)="onVolunteersColumnDragStart($event, 'days')"
                  (dragend)="onVolunteersColumnDragEnd($event)"
                  (dragover)="onVolunteersColumnDragOver($event, 'days')"
                  (dragleave)="onVolunteersColumnDragLeave($event)"
                  (drop)="onVolunteersColumnDrop($event, 'days')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>No. of Days</span>
                </div>
              </th>
              <th *ngIf="column === 'seva' && !isVolunteersColumnHidden('seva')"
                  draggable="true"
                  (dragstart)="onVolunteersColumnDragStart($event, 'seva')"
                  (dragend)="onVolunteersColumnDragEnd($event)"
                  (dragover)="onVolunteersColumnDragOver($event, 'seva')"
                  (dragleave)="onVolunteersColumnDragLeave($event)"
                  (drop)="onVolunteersColumnDrop($event, 'seva')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Seva involved</span>
                </div>
              </th>
            </ng-container>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-vol let-i="rowIndex">
          <tr>
            <ng-container *ngFor="let column of getAllVolunteersColumns()">
              <td *ngIf="column === 'actions' && !isVolunteersColumnHidden('actions')">
              <div class="d-flex gap-1">
                <button class="btn btn-primary btn-sm" (click)="editVolunteer(i)" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-danger btn-sm" (click)="removeVolunteer(i)" title="Remove">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
              <td *ngIf="column === 'name' && !isVolunteersColumnHidden('name')">{{ vol.name }}</td>
              <td *ngIf="column === 'contact' && !isVolunteersColumnHidden('contact')">{{ vol.contact }}</td>
              <td *ngIf="column === 'days' && !isVolunteersColumnHidden('days')">{{ vol.days }}</td>
              <td *ngIf="column === 'seva' && !isVolunteersColumnHidden('seva')">{{ vol.seva }}</td>
            </ng-container>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td [attr.colspan]="getVolunteersVisibleColumnCount()" class="text-center text-muted">No volunteers added yet. Click "Add Volunteer" to add.</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="d-flex justify-content-between mt-3 common-stepper">
    <button class="btn btn-warning" (click)="previousStep()">Back</button>
    <div>
      <button class="btn btn-secondary me-2" (click)="saveAsDraft()" [disabled]="loadingEvent">
        <i class="fas fa-save me-1"></i>Save as Draft
      </button>
      <button class="btn btn-success" (click)="onSubmit()" [disabled]="loadingEvent">
        <i class="fas fa-check me-1"></i>Submit
      </button>
    </div>
  </div>
</div>