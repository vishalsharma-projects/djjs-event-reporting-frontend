<!-- PrimeNG Toast Component -->
<p-toast></p-toast>

<div class="gallery-layout">

  <!-- Left: Vertical Categories -->
  <div class="categories-vertical">
    <button *ngFor="let category of categories" (click)="selectCategory(category)"
      [class.active]="category === selectedCategory">
      {{ category }}
    </button>
  </div>

  <!-- Right: Types + Gallery -->
  <div class="gallery-right">

    <!-- Upload Section -->
    <div class="upload-section mb-3" *ngIf="eventId">
      <input type="file" #fileInput (change)="onFileSelected($event)" multiple
             accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx"
             style="display: none;">
      <button class="btn btn-primary" (click)="fileInput.click()" [disabled]="uploading">
        <i class="pi pi-upload me-2"></i>
        {{ uploading ? 'Uploading...' : 'Upload Files' }}
      </button>
      <span class="ms-2 text-muted" *ngIf="!eventId">(Select an event to upload files)</span>
      <div class="upload-progress mt-2" *ngIf="uploading">
        <div class="progress">
          <div class="progress-bar" [style.width.%]="uploadProgress"></div>
        </div>
        <small class="text-muted">{{ uploadProgress }}% - {{ currentUploadFile }}</small>
      </div>
    </div>

    <!-- Event Info -->
    <div class="alert alert-info mb-3" *ngIf="eventId">
      <i class="pi pi-info-circle"></i> Showing gallery for Event ID: {{ eventId }}
      <button class="btn btn-sm btn-outline-secondary ms-2" (click)="eventId = null; loadGalleryItems()">
        Show All Events
      </button>
    </div>

    <!-- Horizontal Type Tabs -->
    <div class="tabs">
      <button *ngFor="let type of types" (click)="selectType(type)" [class.active]="type === selectedType">
        {{ type | titlecase }}
      </button>
    </div>

    <!-- Grouped by Month-Year -->
    <div *ngFor="let monthYear of getMonthYearKeys()">
      <h3>{{ monthYear }}</h3>
      <div class="gallery">
        <div *ngFor="let item of filteredItemsByMonth[monthYear]" class="thumbnail" (click)="openPopup(item)">
          <div class="thumbnail-overlay">
            <button class="btn btn-sm btn-light me-1" (click)="downloadItem(item, $event)" title="Download">
              <i class="pi pi-download"></i>
            </button>
            <button class="btn btn-sm btn-danger" (click)="deleteItem(item, $event)" title="Delete">
              <i class="pi pi-trash"></i>
            </button>
          </div>
          <ng-container [ngSwitch]="item.type">

            <img *ngSwitchCase="'image'" [src]="item.url" [alt]="item.name">

            <video *ngSwitchCase="'video'" controls>
              <source [src]="item.url" type="video/mp4">
            </video>

            <audio *ngSwitchCase="'audio'" controls>
              <source [src]="item.url" type="audio/mpeg">
            </audio>

            <a *ngSwitchCase="'file'" (click)="openPopup(item); $event.preventDefault()" href="#">
              ðŸ“„ {{ item.name }}
            </a>

          </ng-container>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Popup Modal -->
<div class="popup" *ngIf="selectedItem" (click)="closePopup()">
  <div class="popup-content" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <h5>{{ selectedItem.name }}</h5>
      <div class="popup-actions">
        <button class="btn btn-sm btn-light me-2" (click)="downloadItem(selectedItem, $event)" title="Download">
          <i class="pi pi-download me-1"></i> Download
        </button>
        <button class="btn btn-sm btn-danger" (click)="deleteItem(selectedItem, $event)" title="Delete">
          <i class="pi pi-trash me-1"></i> Delete
        </button>
        <span class="close-btn" (click)="closePopup()">Ã—</span>
      </div>
    </div>

    <ng-container [ngSwitch]="selectedItem.type">

      <img *ngSwitchCase="'image'" [src]="selectedItem.url" [alt]="selectedItem.name"
        style="max-width: 100%; max-height: 85vh;">

      <video *ngSwitchCase="'video'" controls autoplay style="max-width:100%; max-height: 85vh;">
        <source [src]="selectedItem.url" type="video/mp4">
      </video>

      <audio *ngSwitchCase="'audio'" controls autoplay style="width:100%;max-height: 85vh;">
        <source [src]="selectedItem.url" type="audio/mpeg">
      </audio>

      <iframe *ngSwitchCase="'file'" [src]="selectedItem.url" style="width:80vw; height:80vh;"></iframe>

    </ng-container>
  </div>
</div>