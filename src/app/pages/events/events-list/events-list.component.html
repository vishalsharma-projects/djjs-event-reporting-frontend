<div class="row events-list-container">
  <div class="col-12 events-list-content">
    <!-- Page Header with Filters -->
    <div class="page-title-box">
      <div class="row align-items-center mb-1">
        <div class="col-md-6">
          <h4 class="page-title">
            EVENTS
            <span *ngIf="draftsCount > 0" class="badge bg-warning text-dark ms-2">
              {{ draftsCount }} Draft{{ draftsCount > 1 ? 's' : '' }}
            </span>
          </h4>
        </div>
        <div class="col-md-6 text-end">
          <div class="column-visibility-manager" (click)="$event.stopPropagation()">
            <button class="btn btn-outline-info me-2" 
                    (click)="toggleColumnVisibilityMenu()"
                    [class.active]="isColumnVisibilityMenuOpen">
              <i class="pi pi-th-large me-1"></i>
              Columns
              <span class="badge bg-info ms-1" *ngIf="hiddenColumns.length > 0">
                {{ hiddenColumns.length }}
              </span>
            </button>
            <div class="column-visibility-dropdown" [class.show]="isColumnVisibilityMenuOpen">
              <div class="dropdown-header">
                <h6>Column Visibility</h6>
                <button type="button" class="btn btn-link p-0" (click)="closeColumnVisibilityMenu()">
                  <i class="pi pi-times"></i>
                </button>
              </div>
              <div class="dropdown-body">
                <div class="column-visibility-item" *ngFor="let column of getAllColumns()">
                  <label class="d-flex align-items-center">
                    <input type="checkbox" 
                           [checked]="!isColumnHidden(column)"
                           (change)="toggleColumnVisibility(column)" />
                    <span class="ms-2">{{ getColumnDisplayName(column) }}</span>
                    <span *ngIf="isColumnPinned(column)" class="badge bg-warning text-dark ms-2" style="font-size: 0.65rem;">
                      <i class="pi pi-thumbtack"></i> Pinned
                    </span>
                  </label>
                </div>
              </div>
              <div class="dropdown-footer">
                <button type="button" class="btn btn-sm btn-outline-secondary" 
                        (click)="showAllColumns()"
                        [disabled]="hiddenColumns.length === 0">
                  Show All
                </button>
              </div>
            </div>
          </div>
          <!-- <button class="btn btn-outline-secondary me-2"
                  (click)="statusFilter = 'incomplete'; onStatusFilterChange()"
                  [class.active]="statusFilter === 'incomplete'">
            <i class="pi pi-file-edit me-1"></i>
            View Drafts ({{ draftsCount }})
          </button> -->
          <button class="btn btn-outline-success me-2" (click)="openExportModal()" [disabled]="exporting">
            <i class="pi pi-file-excel me-1"></i>
            <span *ngIf="!exporting">Export to Excel</span>
            <span *ngIf="exporting">Exporting...</span>
          </button>
          <button class="btn add-event-btn" (click)="addEvent()">
            <i class="pi pi-plus"></i>
            Add events
          </button>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="row mt-0">
        <div class="col-md-2">
          <div class="form-group mb-0">
            <label for="statusFilter" class="form-label">Status</label>
            <select class="form-select" id="statusFilter" [(ngModel)]="statusFilter" (change)="onStatusFilterChange()">
              <option value="all">All Events</option>
              <option value="complete">Complete</option>
              <option value="incomplete">Incomplete</option>
            </select>
          </div>
        </div>
        <div class="col-md-10">
          <div class="form-group mb-0">
            <label for="searchFilter" class="form-label">Search</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="pi pi-search"></i>
              </span>
              <input type="text" class="form-control" id="searchFilter"
                     placeholder="Search by Branch or area name"
                     [(ngModel)]="searchTerm"
                     (input)="onSearchChange($any($event.target).value)">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PrimeNG Events Table -->
    <p-toast />
    <div class="table-container">
      <p-table #dt [value]="events" dataKey="id" [rowHover]="true" [paginator]="true" 
        [rows]="rows" [first]="first" [rowsPerPageOptions]="rowsPerPageOptions"
        (onPageChange)="onPageChange($event)" (onSort)="onSort($event)"
        [sortMode]="'single'" [tableStyle]="{ 'min-width': '100%' }">

        <!-- Table Header -->
        <ng-template pTemplate="header">
          <tr>
            <ng-container *ngFor="let column of columnOrder">
              <!-- Status Column -->
              <th *ngIf="column === 'status' && !isColumnHidden('status')" style="width: 10%"
                  [class.pinned-column]="isColumnPinned('status')"
                  [ngStyle]="getPinnedStyle('status')"
                  draggable="true"
                  (dragstart)="onColumnDragStart($event, 'status')"
                  (dragend)="onColumnDragEnd($event)"
                  (dragover)="onColumnDragOver($event, 'status')"
                  (dragleave)="onColumnDragLeave($event)"
                  (drop)="onColumnDrop($event, 'status')"
                  class="column-header-draggable">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                    <span>Status</span>
                  </div>
                  <div class="dropdown-container" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
                    <button class="btn btn-sm btn-link p-0" type="button" (click)="toggleDropdown('status')">
                      <i class="pi pi-ellipsis-v"></i>
                    </button>
                    <div class="dropdown-menu" [class.show]="isDropdownOpen('status')">
                      <a class="dropdown-item" href="#" (click)="toggleColumnPin('status'); $event.preventDefault(); $event.stopPropagation()">
                        <i class="pi pi-thumbtack me-2" [class.text-warning]="isColumnPinned('status')"></i>
                        {{ isColumnPinned('status') ? 'Unpin' : 'Pin' }}
                      </a>
                      <a class="dropdown-item" href="#" (click)="toggleColumnVisibility('status'); $event.preventDefault(); $event.stopPropagation()">
                        <i class="pi pi-eye me-2" [class.text-muted]="isColumnHidden('status')"></i>
                        {{ isColumnHidden('status') ? 'Show' : 'Hide' }}
                      </a>
                    </div>
                  </div>
                </div>
              </th>

              <!-- Event Type Column -->
              <th *ngIf="column === 'eventType' && !isColumnHidden('eventType')" style="width: 12%"
                [class.pinned-column]="isColumnPinned('eventType')"
                [ngStyle]="getPinnedStyle('eventType')"
                draggable="true"
                (dragstart)="onColumnDragStart($event, 'eventType')"
                (dragend)="onColumnDragEnd($event)"
                (dragover)="onColumnDragOver($event, 'eventType')"
                (dragleave)="onColumnDragLeave($event)"
                (drop)="onColumnDrop($event, 'eventType')"
                class="column-header-draggable">              
              <div class="d-flex align-items-center sortable-area" pSortableColumn="eventType">
                <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                <span>Type (S)</span>
                <p-sortIcon field="eventType"></p-sortIcon>
              </div>
              <!-- Filter input inside column header -->
              <div *ngIf="activeFilter === 'eventType'" class="mt-2 filter-overlay" (click)="$event.stopPropagation()">
                <input type="text" pInputText class="form-control form-control-sm" placeholder="Filter Event Type"
                  [(ngModel)]="filters['eventType']" (input)="applyFilter()" />
                <button class="btn btn-sm btn-link p-0 ms-1" (click)="clearFilter('eventType')">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </th>

            <th *ngIf="column === 'name' && !isColumnHidden('name')" style="width: 12%"
                [class.pinned-column]="isColumnPinned('name')"
                [ngStyle]="getPinnedStyle('name')"
                draggable="true"
                (dragstart)="onColumnDragStart($event, 'name')"
                (dragend)="onColumnDragEnd($event)"
                (dragover)="onColumnDragOver($event, 'name')"
                (dragleave)="onColumnDragLeave($event)"
                (drop)="onColumnDrop($event, 'name')"
                class="column-header-draggable">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center sortable-area" pSortableColumn="name">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Name</span>
                  <p-sortIcon field="name"></p-sortIcon>
                </div>
                <div class="dropdown-container" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
                  <button class="btn btn-sm btn-link p-0" type="button" (click)="toggleDropdown('name')">
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" [class.show]="isDropdownOpen('name')">
                    <a class="dropdown-item" href="#" (click)="showFilter('name'); $event.preventDefault()">
                      <i class="pi pi-filter me-2"></i>Filter
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnPin('name'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-thumbtack me-2" [class.text-warning]="isColumnPinned('name')"></i>
                      {{ isColumnPinned('name') ? 'Unpin' : 'Pin' }}
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnVisibility('name'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-eye me-2" [class.text-muted]="isColumnHidden('name')"></i>
                      {{ isColumnHidden('name') ? 'Show' : 'Hide' }}
                    </a>
                  </div>
                </div>
              </div>
              <!-- Filter input inside column header -->
              <div *ngIf="activeFilter === 'name'" class="mt-2 filter-overlay" (click)="$event.stopPropagation()">
                <input type="text" pInputText class="form-control form-control-sm" placeholder="Filter Name"
                  [(ngModel)]="filters['name']" (input)="applyFilter()" />
                <button class="btn btn-sm btn-link p-0 ms-1" (click)="clearFilter('name')">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </th>

            <th *ngIf="column === 'duration' && !isColumnHidden('duration')" style="width: 10%"
                [class.pinned-column]="isColumnPinned('duration')"
                [ngStyle]="getPinnedStyle('duration')"
                draggable="true"
                (dragstart)="onColumnDragStart($event, 'duration')"
                (dragend)="onColumnDragEnd($event)"
                (dragover)="onColumnDragOver($event, 'duration')"
                (dragleave)="onColumnDragLeave($event)"
                (drop)="onColumnDrop($event, 'duration')"
                class="column-header-draggable">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center sortable-area" pSortableColumn="duration">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Duration</span>
                  <p-sortIcon field="duration"></p-sortIcon>
                </div>
                <div class="dropdown-container" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
                  <button class="btn btn-sm btn-link p-0" type="button" (click)="toggleDropdown('duration')">
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" [class.show]="isDropdownOpen('duration')">
                    <a class="dropdown-item" href="#" (click)="showFilter('duration'); $event.preventDefault()">
                      <i class="pi pi-filter me-2"></i>Filter
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnPin('duration'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-thumbtack me-2" [class.text-warning]="isColumnPinned('duration')"></i>
                      {{ isColumnPinned('duration') ? 'Unpin' : 'Pin' }}
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnVisibility('duration'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-eye me-2" [class.text-muted]="isColumnHidden('duration')"></i>
                      {{ isColumnHidden('duration') ? 'Show' : 'Hide' }}
                    </a>
                  </div>
                </div>
              </div>
              <!-- Filter input inside column header -->
              <div *ngIf="activeFilter === 'duration'" class="mt-2 filter-overlay" (click)="$event.stopPropagation()">
                <input type="text" pInputText class="form-control form-control-sm" placeholder="Filter Duration"
                  [(ngModel)]="filters['duration']" (input)="applyFilter()" />
                <button class="btn btn-sm btn-link p-0 ms-1" (click)="clearFilter('duration')">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </th>

            <th *ngIf="column === 'days' && !isColumnHidden('days')" style="width: 5%"
                [class.pinned-column]="isColumnPinned('days')"
                [ngStyle]="getPinnedStyle('days')"
                draggable="true"
                (dragstart)="onColumnDragStart($event, 'days')"
                (dragend)="onColumnDragEnd($event)"
                (dragover)="onColumnDragOver($event, 'days')"
                (dragleave)="onColumnDragLeave($event)"
                (drop)="onColumnDrop($event, 'days')"
                class="column-header-draggable">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center sortable-area" pSortableColumn="days">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Days</span>
                  <p-sortIcon field="days"></p-sortIcon>
                </div>
                <div class="dropdown-container" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
                  <button class="btn btn-sm btn-link p-0" type="button" (click)="toggleDropdown('days')">
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" [class.show]="isDropdownOpen('days')">
                    <a class="dropdown-item" href="#" (click)="showFilter('days'); $event.preventDefault()">
                      <i class="pi pi-filter me-2"></i>Filter
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnPin('days'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-thumbtack me-2" [class.text-warning]="isColumnPinned('days')"></i>
                      {{ isColumnPinned('days') ? 'Unpin' : 'Pin' }}
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnVisibility('days'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-eye me-2" [class.text-muted]="isColumnHidden('days')"></i>
                      {{ isColumnHidden('days') ? 'Show' : 'Hide' }}
                    </a>
                  </div>
                </div>
              </div>
              <!-- Filter input inside column header -->
              <div *ngIf="activeFilter === 'days'" class="mt-2 filter-overlay" (click)="$event.stopPropagation()">
                <input type="text" pInputText class="form-control form-control-sm" placeholder="Filter Days"
                  [(ngModel)]="filters['days']" (input)="applyFilter()" />
                <button class="btn btn-sm btn-link p-0 ms-1" (click)="clearFilter('days')">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </th>

            <th *ngIf="column === 'timing' && !isColumnHidden('timing')" style="width: 8%"
                [class.pinned-column]="isColumnPinned('timing')"
                [ngStyle]="getPinnedStyle('timing')"
                draggable="true"
                (dragstart)="onColumnDragStart($event, 'timing')"
                (dragend)="onColumnDragEnd($event)"
                (dragover)="onColumnDragOver($event, 'timing')"
                (dragleave)="onColumnDragLeave($event)"
                (drop)="onColumnDrop($event, 'timing')"
                class="column-header-draggable">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center sortable-area" pSortableColumn="timing">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Timing</span>
                  <p-sortIcon field="timing"></p-sortIcon>
                </div>
                <div class="dropdown-container" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
                  <button class="btn btn-sm btn-link p-0" type="button" (click)="toggleDropdown('timing')">
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" [class.show]="isDropdownOpen('timing')">
                    <a class="dropdown-item" href="#" (click)="showFilter('timing'); $event.preventDefault()">
                      <i class="pi pi-filter me-2"></i>Filter
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnPin('timing'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-thumbtack me-2" [class.text-warning]="isColumnPinned('timing')"></i>
                      {{ isColumnPinned('timing') ? 'Unpin' : 'Pin' }}
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnVisibility('timing'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-eye me-2" [class.text-muted]="isColumnHidden('timing')"></i>
                      {{ isColumnHidden('timing') ? 'Show' : 'Hide' }}
                    </a>
                  </div>
                </div>
              </div>
              <!-- Filter input inside column header -->
              <div *ngIf="activeFilter === 'timing'" class="mt-2 filter-overlay" (click)="$event.stopPropagation()">
                <input type="text" pInputText class="form-control form-control-sm" placeholder="Filter Timing"
                  [(ngModel)]="filters['timing']" (input)="applyFilter()" />
                <button class="btn btn-sm btn-link p-0 ms-1" (click)="clearFilter('timing')">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </th>

            <th *ngIf="column === 'state' && !isColumnHidden('state')" style="width: 8%"
                [class.pinned-column]="isColumnPinned('state')"
                [ngStyle]="getPinnedStyle('state')"
                draggable="true"
                (dragstart)="onColumnDragStart($event, 'state')"
                (dragend)="onColumnDragEnd($event)"
                (dragover)="onColumnDragOver($event, 'state')"
                (dragleave)="onColumnDragLeave($event)"
                (drop)="onColumnDrop($event, 'state')"
                class="column-header-draggable">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center sortable-area" pSortableColumn="state">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>State</span>
                  <p-sortIcon field="state"></p-sortIcon>
                </div>
                <div class="dropdown-container" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
                  <button class="btn btn-sm btn-link p-0" type="button" (click)="toggleDropdown('state')">
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" [class.show]="isDropdownOpen('state')">
                    <a class="dropdown-item" href="#" (click)="showFilter('state'); $event.preventDefault()">
                      <i class="pi pi-filter me-2"></i>Filter
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnPin('state'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-thumbtack me-2" [class.text-warning]="isColumnPinned('state')"></i>
                      {{ isColumnPinned('state') ? 'Unpin' : 'Pin' }}
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnVisibility('state'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-eye me-2" [class.text-muted]="isColumnHidden('state')"></i>
                      {{ isColumnHidden('state') ? 'Show' : 'Hide' }}
                    </a>
                  </div>
                </div>
              </div>
              <!-- Filter input inside column header -->
              <div *ngIf="activeFilter === 'state'" class="mt-2 filter-overlay" (click)="$event.stopPropagation()">
                <input type="text" pInputText class="form-control form-control-sm" placeholder="Filter State"
                  [(ngModel)]="filters['state']" (input)="applyFilter()" />
                <button class="btn btn-sm btn-link p-0 ms-1" (click)="clearFilter('state')">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </th>

            <th *ngIf="column === 'city' && !isColumnHidden('city')" style="width: 8%"
                [class.pinned-column]="isColumnPinned('city')"
                [ngStyle]="getPinnedStyle('city')"
                draggable="true"
                (dragstart)="onColumnDragStart($event, 'city')"
                (dragend)="onColumnDragEnd($event)"
                (dragover)="onColumnDragOver($event, 'city')"
                (dragleave)="onColumnDragLeave($event)"
                (drop)="onColumnDrop($event, 'city')"
                class="column-header-draggable">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center sortable-area" pSortableColumn="city">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>City</span>
                  <p-sortIcon field="city"></p-sortIcon>
                </div>
                <div class="dropdown-container" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
                  <button class="btn btn-sm btn-link p-0" type="button" (click)="toggleDropdown('city')">
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" [class.show]="isDropdownOpen('city')">
                    <a class="dropdown-item" href="#" (click)="showFilter('city'); $event.preventDefault()">
                      <i class="pi pi-filter me-2"></i>Filter
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnPin('city'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-thumbtack me-2" [class.text-warning]="isColumnPinned('city')"></i>
                      {{ isColumnPinned('city') ? 'Unpin' : 'Pin' }}
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnVisibility('city'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-eye me-2" [class.text-muted]="isColumnHidden('city')"></i>
                      {{ isColumnHidden('city') ? 'Show' : 'Hide' }}
                    </a>
                  </div>
                </div>
              </div>
              <!-- Filter input inside column header -->
              <div *ngIf="activeFilter === 'city'" class="mt-2 filter-overlay" (click)="$event.stopPropagation()">
                <input type="text" pInputText class="form-control form-control-sm" placeholder="Filter City"
                  [(ngModel)]="filters['city']" (input)="applyFilter()" />
                <button class="btn btn-sm btn-link p-0 ms-1" (click)="clearFilter('city')">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </th>

            <th *ngIf="column === 'branch' && !isColumnHidden('branch')" style="width: 12%"
                [class.pinned-column]="isColumnPinned('branch')"
                [ngStyle]="getPinnedStyle('branch')"
                draggable="true"
                (dragstart)="onColumnDragStart($event, 'branch')"
                (dragend)="onColumnDragEnd($event)"
                (dragover)="onColumnDragOver($event, 'branch')"
                (dragleave)="onColumnDragLeave($event)"
                (drop)="onColumnDrop($event, 'branch')"
                class="column-header-draggable">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center sortable-area" pSortableColumn="branch">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Branch</span>
                  <p-sortIcon field="branch"></p-sortIcon>
                </div>
                <div class="dropdown-container" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
                  <button class="btn btn-sm btn-link p-0" type="button" (click)="toggleDropdown('branch')">
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" [class.show]="isDropdownOpen('branch')">
                    <a class="dropdown-item" href="#" (click)="showFilter('branch'); $event.preventDefault()">
                      <i class="pi pi-filter me-2"></i>Filter
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnPin('branch'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-thumbtack me-2" [class.text-warning]="isColumnPinned('branch')"></i>
                      {{ isColumnPinned('branch') ? 'Unpin' : 'Pin' }}
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnVisibility('branch'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-eye me-2" [class.text-muted]="isColumnHidden('branch')"></i>
                      {{ isColumnHidden('branch') ? 'Show' : 'Hide' }}
                    </a>
                  </div>
                </div>
              </div>
              <!-- Filter input inside column header -->
              <div *ngIf="activeFilter === 'branch'" class="mt-2 filter-overlay" (click)="$event.stopPropagation()">
                <input type="text" pInputText class="form-control form-control-sm" placeholder="Filter Branch"
                  [(ngModel)]="filters['branch']" (input)="applyFilter()" />
                <button class="btn btn-sm btn-link p-0 ms-1" (click)="clearFilter('branch')">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </th>

            <th *ngIf="column === 'spiritualOrator' && !isColumnHidden('spiritualOrator')" style="width: 7%; min-width: 100px;"
                [class.pinned-column]="isColumnPinned('spiritualOrator')"
                [ngStyle]="getPinnedStyle('spiritualOrator')"
                draggable="true"
                (dragstart)="onColumnDragStart($event, 'spiritualOrator')"
                (dragend)="onColumnDragEnd($event)"
                (dragover)="onColumnDragOver($event, 'spiritualOrator')"
                (dragleave)="onColumnDragLeave($event)"
                (drop)="onColumnDrop($event, 'spiritualOrator')"
                class="column-header-draggable">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center sortable-area" pSortableColumn="spiritualOrator">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Orator</span>
                  <p-sortIcon field="spiritualOrator"></p-sortIcon>
                </div>
                <div class="dropdown-container" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
                  <button class="btn btn-sm btn-link p-0" type="button" (click)="toggleDropdown('spiritualOrator')">
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" [class.show]="isDropdownOpen('spiritualOrator')">
                    <a class="dropdown-item" href="#" (click)="showFilter('spiritualOrator'); $event.preventDefault()">
                      <i class="pi pi-filter me-2"></i>Filter
                    </a>
                    <a class="dropdown-item" href="#"
                      (click)="toggleColumnPin('spiritualOrator'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-thumbtack me-2" [class.text-warning]="isColumnPinned('spiritualOrator')"></i>
                      {{ isColumnPinned('spiritualOrator') ? 'Unpin' : 'Pin' }}
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnVisibility('spiritualOrator'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-eye me-2" [class.text-muted]="isColumnHidden('spiritualOrator')"></i>
                      {{ isColumnHidden('spiritualOrator') ? 'Show' : 'Hide' }}
                    </a>
                  </div>
                </div>
              </div>
              <!-- Filter input inside column header -->
              <div *ngIf="activeFilter === 'spiritualOrator'" class="mt-2 filter-overlay" (click)="$event.stopPropagation()">
                <input type="text" pInputText class="form-control form-control-sm" placeholder="Filter Orator"
                  [(ngModel)]="filters['spiritualOrator']" (input)="applyFilter()" />
                <button class="btn btn-sm btn-link p-0 ms-1" (click)="clearFilter('spiritualOrator')">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </th>

            <th *ngIf="column === 'language' && !isColumnHidden('language')" style="width: 5%; min-width: 80px;"
                [class.pinned-column]="isColumnPinned('language')"
                [ngStyle]="getPinnedStyle('language')"
                draggable="true"
                (dragstart)="onColumnDragStart($event, 'language')"
                (dragend)="onColumnDragEnd($event)"
                (dragover)="onColumnDragOver($event, 'language')"
                (dragleave)="onColumnDragLeave($event)"
                (drop)="onColumnDrop($event, 'language')"
                class="column-header-draggable">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center sortable-area" pSortableColumn="language">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Language</span>
                  <p-sortIcon field="language"></p-sortIcon>
                </div>
                <div class="dropdown-container" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
                  <button class="btn btn-sm btn-link p-0" type="button" (click)="toggleDropdown('language')">
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" [class.show]="isDropdownOpen('language')">
                    <a class="dropdown-item" href="#" (click)="showFilter('language'); $event.preventDefault()">
                      <i class="pi pi-filter me-2"></i>Filter
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnPin('language'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-thumbtack me-2" [class.text-warning]="isColumnPinned('language')"></i>
                      {{ isColumnPinned('language') ? 'Unpin' : 'Pin' }}
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnVisibility('language'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-eye me-2" [class.text-muted]="isColumnHidden('language')"></i>
                      {{ isColumnHidden('language') ? 'Show' : 'Hide' }}
                    </a>
                  </div>
                </div>
              </div>
              <!-- Filter input inside column header -->
              <div *ngIf="activeFilter === 'language'" class="mt-2 filter-overlay" (click)="$event.stopPropagation()">
                <input type="text" pInputText class="form-control form-control-sm" placeholder="Filter Language"
                  [(ngModel)]="filters['language']" (input)="applyFilter()" />
                <button class="btn btn-sm btn-link p-0 ms-1" (click)="clearFilter('language')">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </th>

            <th *ngIf="column === 'beneficiaries' && !isColumnHidden('beneficiaries')" style="width: 6%; min-width: 90px;"
                [class.pinned-column]="isColumnPinned('beneficiaries')"
                [ngStyle]="getPinnedStyle('beneficiaries')"
                draggable="true"
                (dragstart)="onColumnDragStart($event, 'beneficiaries')"
                (dragend)="onColumnDragEnd($event)"
                (dragover)="onColumnDragOver($event, 'beneficiaries')"
                (dragleave)="onColumnDragLeave($event)"
                (drop)="onColumnDrop($event, 'beneficiaries')"
                class="column-header-draggable">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center sortable-area" pSortableColumn="beneficiaries">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Beneficiaries</span>
                  <p-sortIcon field="beneficiaries"></p-sortIcon>
                </div>
                <div class="dropdown-container" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
                  <button class="btn btn-sm btn-link p-0" type="button" (click)="toggleDropdown('beneficiaries')">
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" [class.show]="isDropdownOpen('beneficiaries')">
                    <a class="dropdown-item" href="#" (click)="showFilter('beneficiaries'); $event.preventDefault()">
                      <i class="pi pi-filter me-2"></i>Filter
                    </a>
                    <a class="dropdown-item" href="#"
                      (click)="toggleColumnPin('beneficiaries'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-thumbtack me-2" [class.text-warning]="isColumnPinned('beneficiaries')"></i>
                      {{ isColumnPinned('beneficiaries') ? 'Unpin' : 'Pin' }}
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnVisibility('beneficiaries'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-eye me-2" [class.text-muted]="isColumnHidden('beneficiaries')"></i>
                      {{ isColumnHidden('beneficiaries') ? 'Show' : 'Hide' }}
                    </a>
                  </div>
                </div>
              </div>
              <!-- Filter input inside column header -->
              <div *ngIf="activeFilter === 'beneficiaries'" class="mt-2 filter-overlay" (click)="$event.stopPropagation()">
                <input type="text" pInputText class="form-control form-control-sm" placeholder="Filter Beneficiaries"
                  [(ngModel)]="filters['beneficiaries']" (input)="applyFilter()" />
                <button class="btn btn-sm btn-link p-0 ms-1" (click)="clearFilter('beneficiaries')">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </th>

            <th *ngIf="column === 'initiation' && !isColumnHidden('initiation')" style="width: 6%; min-width: 85px;"
                [class.pinned-column]="isColumnPinned('initiation')"
                [ngStyle]="getPinnedStyle('initiation')"
                draggable="true"
                (dragstart)="onColumnDragStart($event, 'initiation')"
                (dragend)="onColumnDragEnd($event)"
                (dragover)="onColumnDragOver($event, 'initiation')"
                (dragleave)="onColumnDragLeave($event)"
                (drop)="onColumnDrop($event, 'initiation')"
                class="column-header-draggable">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center sortable-area" pSortableColumn="initiation">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Initiation</span>
                  <p-sortIcon field="initiation"></p-sortIcon>
                </div>
                <div class="dropdown-container" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
                  <button class="btn btn-sm btn-link p-0" type="button" (click)="toggleDropdown('initiation')">
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" [class.show]="isDropdownOpen('initiation')">
                    <a class="dropdown-item" href="#" (click)="showFilter('initiation'); $event.preventDefault()">
                      <i class="pi pi-filter me-2"></i>Filter
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnPin('initiation'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-thumbtack me-2" [class.text-warning]="isColumnPinned('initiation')"></i>
                      {{ isColumnPinned('initiation') ? 'Unpin' : 'Pin' }}
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnVisibility('initiation'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-eye me-2" [class.text-muted]="isColumnHidden('initiation')"></i>
                      {{ isColumnHidden('initiation') ? 'Show' : 'Hide' }}
                    </a>
                  </div>
                </div>
              </div>
              <!-- Filter input inside column header -->
              <div *ngIf="activeFilter === 'initiation'" class="mt-2 filter-overlay" (click)="$event.stopPropagation()">
                <input type="text" pInputText class="form-control form-control-sm" placeholder="Filter Initiation"
                  [(ngModel)]="filters['initiation']" (input)="applyFilter()" />
                <button class="btn btn-sm btn-link p-0 ms-1" (click)="clearFilter('initiation')">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </th>

            <th *ngIf="column === 'specialGuests' && !isColumnHidden('specialGuests')" style="width: 5%; min-width: 100px;"
                [class.pinned-column]="isColumnPinned('specialGuests')"
                [ngStyle]="getPinnedStyle('specialGuests')"
                draggable="true"
                (dragstart)="onColumnDragStart($event, 'specialGuests')"
                (dragend)="onColumnDragEnd($event)"
                (dragover)="onColumnDragOver($event, 'specialGuests')"
                (dragleave)="onColumnDragLeave($event)"
                (drop)="onColumnDrop($event, 'specialGuests')"
                class="column-header-draggable">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center sortable-area" pSortableColumn="specialGuests">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Special Guests</span>
                  <p-sortIcon field="specialGuests"></p-sortIcon>
                </div>
                <div class="dropdown-container" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
                  <button class="btn btn-sm btn-link p-0" type="button" (click)="toggleDropdown('specialGuests')">
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" [class.show]="isDropdownOpen('specialGuests')">
                    <a class="dropdown-item" href="#" (click)="showFilter('specialGuests'); $event.preventDefault()">
                      <i class="pi pi-filter me-2"></i>Filter
                    </a>
                    <a class="dropdown-item" href="#"
                      (click)="toggleColumnPin('specialGuests'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-thumbtack me-2" [class.text-warning]="isColumnPinned('specialGuests')"></i>
                      {{ isColumnPinned('specialGuests') ? 'Unpin' : 'Pin' }}
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnVisibility('specialGuests'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-eye me-2" [class.text-muted]="isColumnHidden('specialGuests')"></i>
                      {{ isColumnHidden('specialGuests') ? 'Show' : 'Hide' }}
                    </a>
                  </div>
                </div>
              </div>
              <!-- Filter input inside column header -->
              <div *ngIf="activeFilter === 'specialGuests'" class="mt-2 filter-overlay" (click)="$event.stopPropagation()">
                <input type="text" pInputText class="form-control form-control-sm" placeholder="Filter Special Guests"
                  [(ngModel)]="filters['specialGuests']" (input)="applyFilter()" />
                <button class="btn btn-sm btn-link p-0 ms-1" (click)="clearFilter('specialGuests')">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </th>

            <th *ngIf="column === 'volunteers' && !isColumnHidden('volunteers')" style="width: 5%; min-width: 90px;"
                [class.pinned-column]="isColumnPinned('volunteers')"
                [ngStyle]="getPinnedStyle('volunteers')"
                draggable="true"
                (dragstart)="onColumnDragStart($event, 'volunteers')"
                (dragend)="onColumnDragEnd($event)"
                (dragover)="onColumnDragOver($event, 'volunteers')"
                (dragleave)="onColumnDragLeave($event)"
                (drop)="onColumnDrop($event, 'volunteers')"
                class="column-header-draggable">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center sortable-area" pSortableColumn="volunteers">
                  <i class="pi pi-bars me-1 text-muted" style="cursor: move; font-size: 0.8rem;" title="Drag to reorder"></i>
                  <span>Volunteers</span>
                  <p-sortIcon field="volunteers"></p-sortIcon>
                </div>
                <div class="dropdown-container" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
                  <button class="btn btn-sm btn-link p-0" type="button" (click)="toggleDropdown('volunteers')">
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" [class.show]="isDropdownOpen('volunteers')">
                    <a class="dropdown-item" href="#" (click)="showFilter('volunteers'); $event.preventDefault()">
                      <i class="pi pi-filter me-2"></i>Filter
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnPin('volunteers'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-thumbtack me-2" [class.text-warning]="isColumnPinned('volunteers')"></i>
                      {{ isColumnPinned('volunteers') ? 'Unpin' : 'Pin' }}
                    </a>
                    <a class="dropdown-item" href="#" (click)="toggleColumnVisibility('volunteers'); $event.preventDefault(); $event.stopPropagation()">
                      <i class="pi pi-eye me-2" [class.text-muted]="isColumnHidden('volunteers')"></i>
                      {{ isColumnHidden('volunteers') ? 'Show' : 'Hide' }}
                    </a>
                  </div>
                </div>
              </div>
              <!-- Filter input inside column header -->
              <div *ngIf="activeFilter === 'volunteers'" class="mt-2 filter-overlay" (click)="$event.stopPropagation()">
                <input type="text" pInputText class="form-control form-control-sm" placeholder="Filter Volunteers"
                  [(ngModel)]="filters['volunteers']" (input)="applyFilter()" />
                <button class="btn btn-sm btn-link p-0 ms-1" (click)="clearFilter('volunteers')">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </th>
            </ng-container>
          </tr>
        </ng-template>

        <!-- Table Body -->
        <ng-template pTemplate="body" let-event>
          <tr>
            <ng-container *ngFor="let column of columnOrder">
              <td *ngIf="!isColumnHidden(column)" 
                  [class.pinned-column]="isColumnPinned(column)" 
                  [ngStyle]="getPinnedStyle(column)">
                <!-- Special rendering for status -->
                <ng-container *ngIf="column === 'status'">
                  <div class="d-flex align-items-center ">
                    <div class="action-menu-container" (click)="$event.stopPropagation()">
                      <button
                        class="btn btn-link p-0 action-menu-btn"
                        type="button"
                        (click)="toggleActionMenu(event.id, $event)">
                        <i class="pi pi-ellipsis-v"></i>
                      </button>
                      <div class="action-menu-dropdown" 
                           [class.show]="isActionMenuOpen(event.id)"
                           [class.position-up]="getActionMenuPosition(event.id) === 'up'">
                        <a class="dropdown-item" href="#"
                          [routerLink]="['/events/edit', event.id]"
                          (click)="closeActionMenu()"
                          title="Edit">
                          <i class="pi pi-pencil"></i>
                          <span>Edit</span>
                        </a>
                        <a class="dropdown-item" href="#" [routerLink]="['/events/view', event.id]" (click)="closeActionMenu()"
                          title="More details">
                          <i class="pi pi-eye"></i>
                          <span>View</span>
                        </a>
                        <a class="dropdown-item" href="#" (click)="downloadEvent(event.id); closeActionMenu(); $event.preventDefault()"
                          title="Download">
                          <i class="pi pi-download"></i>
                          <span>Download</span>
                        </a>
                        <a class="dropdown-item" href="#" (click)="openGallery(event); closeActionMenu(); $event.preventDefault()"
                          title="View in Gallery">
                          <i class="pi pi-images"></i>
                          <span>Gallery</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="#" (click)="deleteEvent(event.id); closeActionMenu(); $event.preventDefault()"
                          title="Delete Event">
                          <i class="pi pi-trash"></i>
                          <span>Delete</span>
                        </a>
                      </div>
                    </div>
                    <p-tag
                      [value]="event.status === 'complete' ? 'Complete' : 'incomplete'"
                      [severity]="event.status === 'complete' ? 'success' : 'warning'">
                    </p-tag>
                  </div>
                </ng-container>
                <!-- Special rendering for eventType -->
                <ng-container *ngIf="column === 'eventType'">
                  <p-tag [value]="getEventTypeDisplay(event)" [severity]="getSeverity(event.scale)" />
                </ng-container>
                <!-- Special rendering for beneficiaries -->
                <ng-container *ngIf="column === 'beneficiaries'">
                  <span class="cursor-pointer text-primary" (click)="openBeneficiariesModal(event); $event.stopPropagation()">
                    {{ event.beneficiaries.total }}
                  </span>
                  <i class="pi pi-info-circle text-primary ms-1" pTooltip="Click to view Beneficiaries details"
                    tooltipPosition="top"></i>
                </ng-container>
                <!-- Special rendering for initiation -->
                <ng-container *ngIf="column === 'initiation'">
                  <span class="cursor-pointer text-primary" (click)="openInitiationModal(event); $event.stopPropagation()">
                    {{ event.initiation.total }}
                  </span>
                  <i class="pi pi-info-circle text-primary ms-1" pTooltip="Click to view Initiation details"
                    tooltipPosition="top"></i>
                </ng-container>
                <!-- Special rendering for specialGuests -->
                <ng-container *ngIf="column === 'specialGuests'">
                  <span class="cursor-pointer text-primary" (click)="openSpecialGuestsModal(event); $event.stopPropagation()">
                    {{ event.specialGuests }}
                  </span>
                  <i class="pi pi-info-circle text-primary ms-1" pTooltip="Click to view Special Guests"
                    tooltipPosition="top"></i>
                </ng-container>
                <!-- Special rendering for volunteers -->
                <ng-container *ngIf="column === 'volunteers'">
                  <span class="cursor-pointer text-primary" (click)="openVolunteersModal(event); $event.stopPropagation()">
                    {{ event.volunteers }}
                  </span>
                  <i class="pi pi-info-circle text-primary ms-1" pTooltip="Click to view Volunteers"
                    tooltipPosition="top"></i>
                </ng-container>
                <!-- Default rendering for other columns -->
                <ng-container *ngIf="column !== 'status' && column !== 'eventType' && column !== 'beneficiaries' && column !== 'initiation' && column !== 'specialGuests' && column !== 'volunteers'">
                  {{ getColumnCellContent(event, column) }}
                </ng-container>
              </td>
            </ng-container>
          </tr>
        </ng-template>

        <!-- Empty Message -->
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="14" class="text-center p-4">
              <i class="pi pi-inbox text-muted" style="font-size: 2rem;"></i>
              <p class="text-muted mt-2">No events found.</p>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>

<!-- Beneficiaries Drawer -->
<div class="volunteer-drawer-backdrop"
     *ngIf="isBeneficiariesDrawerOpen"
     (click)="closeBeneficiariesDrawer()"
     [class.show]="isBeneficiariesDrawerOpen">
</div>

<div class="volunteer-drawer"
     *ngIf="isBeneficiariesDrawerOpen"
     [class.show]="isBeneficiariesDrawerOpen"
     (click)="$event.stopPropagation()">
  <div class="drawer-header">
    <h5 id="beneficiariesDrawerTitle">Beneficiaries ({{ selectedEvent?.beneficiaries?.total || 0 }})</h5>
    <button type="button"
            class="drawer-close"
            (click)="closeBeneficiariesDrawer()"
            aria-label="Close">
      
    </button>
  </div>

  <div class="drawer-content">
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="text-center p-3 bg-light rounded">
          <h6 class="text-primary">Men</h6>
          <h4 class="mb-0">{{ selectedEvent?.beneficiaries?.men || 0 }}</h4>
        </div>
      </div>
      <div class="col-md-4">
        <div class="text-center p-3 bg-light rounded">
          <h6 class="text-success">Women</h6>
          <h4 class="mb-0">{{ selectedEvent?.beneficiaries?.women || 0 }}</h4>
        </div>
      </div>
      <div class="col-md-4">
        <div class="text-center p-3 bg-light rounded">
          <h6 class="text-warning">Children</h6>
          <h4 class="mb-0">{{ selectedEvent?.beneficiaries?.children || 0 }}</h4>
        </div>
      </div>
    </div>
    <div class="text-center">
      <p class="text-muted">People who attended and benefited from the event</p>
      <div class="mt-3">
        <span class="badge bg-primary me-2">Total: {{ selectedEvent?.beneficiaries?.total || 0 }}</span>
        <span class="badge bg-info">Event: {{ selectedEvent?.name }}</span>
      </div>
    </div>
  </div>

  <div class="drawer-footer">
    <button type="button" class="btn btn-secondary" (click)="closeBeneficiariesDrawer()">Close</button>
  </div>
</div>

<!-- Initiation Drawer -->
<div class="volunteer-drawer-backdrop"
     *ngIf="isInitiationDrawerOpen"
     (click)="closeInitiationDrawer()"
     [class.show]="isInitiationDrawerOpen">
</div>

<div class="volunteer-drawer"
     *ngIf="isInitiationDrawerOpen"
     [class.show]="isInitiationDrawerOpen"
     (click)="$event.stopPropagation()">
  <div class="drawer-header">
    <h5 id="initiationDrawerTitle">Initiation ({{ selectedEvent?.initiation?.total || 0 }})</h5>
    <button type="button"
            class="drawer-close"
            (click)="closeInitiationDrawer()"
            aria-label="Close">
      
    </button>
  </div>

  <div class="drawer-content">
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="text-center p-3 bg-light rounded">
          <h6 class="text-primary">Men</h6>
          <h4 class="mb-0">{{ selectedEvent?.initiation?.men || 0 }}</h4>
        </div>
      </div>
      <div class="col-md-4">
        <div class="text-center p-3 bg-light rounded">
          <h6 class="text-success">Women</h6>
          <h4 class="mb-0">{{ selectedEvent?.initiation?.women || 0 }}</h4>
        </div>
      </div>
      <div class="col-md-4">
        <div class="text-center p-3 bg-light rounded">
          <h6 class="text-warning">Children</h6>
          <h4 class="mb-0">{{ selectedEvent?.initiation?.children || 0 }}</h4>
        </div>
      </div>
    </div>
    <div class="text-center">
      <p class="text-muted">People who took Gyan (spiritual knowledge) during the event</p>
      <div class="mt-3">
        <span class="badge bg-primary me-2">Total: {{ selectedEvent?.initiation?.total || 0 }}</span>
        <span class="badge bg-info">Event: {{ selectedEvent?.name }}</span>
      </div>
    </div>
  </div>

  <div class="drawer-footer">
    <button type="button" class="btn btn-secondary" (click)="closeInitiationDrawer()">Close</button>
  </div>
</div>

<!-- Special Guests Drawer -->
<div class="volunteer-drawer-backdrop"
     *ngIf="isSpecialGuestsDrawerOpen"
     (click)="closeSpecialGuestsDrawer()"
     [class.show]="isSpecialGuestsDrawerOpen">
</div>

<div class="volunteer-drawer"
     *ngIf="isSpecialGuestsDrawerOpen"
     [class.show]="isSpecialGuestsDrawerOpen"
     (click)="$event.stopPropagation()">
  <div class="drawer-header">
    <h5 id="specialGuestsDrawerTitle">Special guest ({{ selectedEvent?.specialGuests || 0 }})</h5>
    <button type="button"
            class="drawer-close"
            (click)="closeSpecialGuestsDrawer()"
            aria-label="Close">
      
    </button>
  </div>

  <div class="drawer-content">
    <div *ngIf="!selectedEvent?.specialGuestsList || selectedEvent.specialGuestsList.length === 0" class="text-center">
      <i class="pi pi-users text-muted" style="font-size: 3rem;"></i>
      <p class="text-muted mt-3">No special guests found for this event.</p>
    </div>
    <div *ngIf="selectedEvent?.specialGuestsList && selectedEvent.specialGuestsList.length > 0">
      <table>
        <thead>
          <tr>
            <th>Name (Phone no.)</th>
            <th>Gender</th>
            <th>Designation</th>
            <th>Organization</th>
            <th>Email</th>
            <th>City, State</th>
            <th>Contact Person (Phone no.)</th>
            <th>Reference Person (Phone no.)</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let guest of selectedEvent.specialGuestsList">
            <td data-label="Name (Phone no.)">{{ guest.name }} ({{ guest.phone }})</td>
            <td data-label="Gender">{{ guest.gender }}</td>
            <td data-label="Designation">{{ guest.designation }}</td>
            <td data-label="Organization">{{ guest.organization }}</td>
            <td data-label="Email">{{ guest.email }}</td>
            <td data-label="City, State">{{ guest.city }}, {{ guest.state }}</td>
            <td data-label="Contact Person (Phone no.)">{{ guest.contactPerson }} ({{ guest.contactPhone }})</td>
            <td data-label="Reference Person (Phone no.)">{{ guest.referencePerson }} ({{ guest.referencePhone }})</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="drawer-footer">
    <button type="button"
            class="btn btn-outline-primary me-2"
            (click)="exportSpecialGuestsToExcel()"
            [disabled]="exportingSpecialGuests || !selectedEvent?.specialGuestsList || selectedEvent.specialGuestsList.length === 0">
      <i class="pi pi-file-excel me-1"></i>
      <span *ngIf="!exportingSpecialGuests">Export to Excel</span>
      <span *ngIf="exportingSpecialGuests">Exporting...</span>
    </button>
    <button type="button" class="btn btn-secondary" (click)="closeSpecialGuestsDrawer()">Close</button>
  </div>
</div>

<!-- Volunteers Drawer - Custom Right-Side Drawer -->
<div class="volunteer-drawer-backdrop"
     *ngIf="isVolunteerDrawerOpen"
     (click)="closeVolunteerDrawer()"
     [class.show]="isVolunteerDrawerOpen">
</div>

<div class="volunteer-drawer"
     *ngIf="isVolunteerDrawerOpen"
     [class.show]="isVolunteerDrawerOpen"
     (click)="$event.stopPropagation()">
  <!-- Drawer Header -->
  <div class="drawer-header">
    <h5 id="volunteerDrawerTitle">Volunteer ({{ getVolunteerCount() }})</h5>
    <button type="button"
            class="drawer-close"
            (click)="closeVolunteerDrawer()"
            aria-label="Close">
      
    </button>
  </div>

  <!-- Drawer Content - Scrollable Content -->
  <div class="drawer-content">
    <div *ngIf="!selectedEvent?.volunteersList || selectedEvent.volunteersList.length === 0" class="text-center">
      <i class="pi pi-users text-muted" style="font-size: 3rem;"></i>
      <p class="text-muted mt-3">No volunteers found for this event.</p>
    </div>
    <div *ngIf="selectedEvent?.volunteersList && selectedEvent.volunteersList.length > 0">
      <table>
        <thead>
          <tr>
            <th>Branch</th>
            <th>Name</th>
            <th>Gender</th>
            <th>Contact no.</th>
            <th>Seva Involved</th>
            <th>No. of Days</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let volunteer of selectedEvent.volunteersList">
            <td data-label="Branch">{{ volunteer.branch || 'Branch name' }}</td>
            <td data-label="Name">{{ volunteer.name }}</td>
            <td data-label="Gender">{{ volunteer.gender || 'N/A' }}</td>
            <td data-label="Contact no.">{{ volunteer.contact || '000000000' }}</td>
            <td data-label="Seva Involved">{{ volunteer.seva }}</td>
            <td data-label="No. of Days">{{ volunteer.days }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Drawer Footer -->
  <div class="drawer-footer">
    <button type="button"
            class="btn btn-outline-primary me-2"
            (click)="exportVolunteersToExcel()"
            [disabled]="exportingVolunteers || !selectedEvent?.volunteersList || selectedEvent.volunteersList.length === 0">
      <i class="pi pi-file-excel me-1"></i>
      <span *ngIf="!exportingVolunteers">Export to Excel</span>
      <span *ngIf="exportingVolunteers">Exporting...</span>
    </button>
    <button type="button"
            class="btn btn-secondary"
            (click)="closeVolunteerDrawer()">
      Close
    </button>
  </div>
</div>

<!-- More Details Modal -->
<div class="modal fade" id="moreDetailsModal" tabindex="-1" aria-labelledby="moreDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="moreDetailsModalLabel">More details</h5>
        <button type="button" class="btn-close" (click)="closeModal('moreDetailsModal')" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Theme/Message Section -->
          <div class="col-12 mb-4">
            <h6 class="fw-bold">Theme/ Message given:</h6>
            <p class="text-primary">{{ selectedEvent?.theme || 'Manthan' }}</p>
          </div>

          <!-- Donation Section -->
          <div class="col-12 mb-4">
            <h6 class="fw-bold">Donation:</h6>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Donation Type</th>
                    <th>Additional Details</th>
                    <th>Amount (in Rupees)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let donation of selectedEvent?.donations">
                    <td>{{ donation.type }}</td>
                    <td>{{ donation.details || '-' }}</td>
                    <td>Rs. {{ donation.amount | number }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Event Media Section -->
          <div class="col-12 mb-4">
            <h6 class="fw-bold">Event media:</h6>
            <div class="row">
              <div class="col-md-6">
                <p><strong>Media coverage type:</strong> <span class="text-primary">{{
                    selectedEvent?.media?.coverageType || 'link' }}</span></p>
                <p><strong>Organization/ Comp...:</strong> <span class="text-primary">{{
                    selectedEvent?.media?.organization || 'link' }}</span></p>
                <p><strong>Media email:</strong> 
                  <span *ngFor="let email of getEmailArray(selectedEvent?.media?.email); let last = last" class="me-2">
                    <span class="badge bg-info text-dark">{{ email }}</span>
                  </span>
                  <span *ngIf="!selectedEvent?.media?.email || getEmailArray(selectedEvent?.media?.email).length === 0" class="text-muted">N/A</span>
                </p>
                <p><strong>Media website:</strong> <span class="text-primary">{{ selectedEvent?.media?.website ||
                    'www.link.in' }}</span></p>
              </div>
              <div class="col-md-6">
                <p><strong>Media person:</strong> {{ selectedEvent?.media?.person || 'Mr. First middle last' }}</p>
                <p><strong>Designation:</strong> <span class="text-primary">{{ selectedEvent?.media?.designation ||
                    'link' }}</span></p>
                <p><strong>Contact:</strong> {{ selectedEvent?.media?.contact || '000000000' }}</p>
                <p><strong>Email:</strong> 
                  <span *ngFor="let email of getEmailArray(selectedEvent?.media?.personEmail); let last = last" class="me-2">
                    <span class="badge bg-info text-dark">{{ email }}</span>
                  </span>
                  <span *ngIf="!selectedEvent?.media?.personEmail || getEmailArray(selectedEvent?.media?.personEmail).length === 0" class="text-muted">N/A</span>
                </p>
                <p><strong>Reference person:</strong> {{ selectedEvent?.media?.referencePerson || 'Mr. First middle
                  last' }}</p>
              </div>
            </div>
          </div>

          <!-- Promotional Material Section -->
          <div class="col-12 mb-4">
            <h6 class="fw-bold">Promotional material used:</h6>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Quantity</th>
                    <th>Size</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let material of selectedEvent?.promotionalMaterials">
                    <td>{{ material.name }}</td>
                    <td>{{ material.quantity }}</td>
                    <td>{{ material.size }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Media and Documentation Section -->
          <div class="col-12 mb-4">
            <h6 class="fw-bold">Media and Documentation:</h6>
            <div class="d-flex flex-wrap gap-3">
              <span class="cursor-pointer" (click)="openMediaContentModal('photos'); $event.preventDefault()">{{
                selectedEvent?.media?.photos || 'Event photos' }}</span>
              <span class="cursor-pointer" (click)="openMediaContentModal('video'); $event.preventDefault()">{{
                selectedEvent?.media?.video || 'Video Coverage' }}</span>
              <span class="cursor-pointer" (click)="openMediaContentModal('pressRelease'); $event.preventDefault()">{{
                selectedEvent?.media?.pressRelease || 'Press Release' }}</span>
              <span class="cursor-pointer" (click)="openMediaContentModal('testimonials'); $event.preventDefault()">{{
                selectedEvent?.media?.testimonials || 'Testimonials' }}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button"
                class="btn btn-outline-primary me-2"
                (click)="exportEventMediaToExcel()"
                [disabled]="exportingMedia || !selectedEvent?.id">
          <i class="pi pi-file-excel me-1"></i>
          <span *ngIf="!exportingMedia">Export Media to Excel</span>
          <span *ngIf="exportingMedia">Exporting...</span>
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeModal('moreDetailsModal')">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Media Content Modal -->
<div class="modal fade" id="mediaContentModal" tabindex="-1" aria-labelledby="mediaContentModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mediaContentModalLabel">
          {{ getMediaModalTitle() }}
        </h5>
        <button type="button" class="btn-close" (click)="closeMediaContentModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center p-4">
          <div class="media-content-display">
            <i class="pi pi-image text-primary" style="font-size: 3rem;"></i>
            <h4 class="mt-3">{{ getMediaModalTitle() }}</h4>
            <p class="text-muted mt-2">
              {{ getMediaContentDescription() }}
            </p>
            <div class="mt-4">
              <button class="btn btn-primary me-2">
                <i class="pi pi-download me-2"></i>Download
              </button>
              <button class="btn btn-outline-secondary">
                <i class="pi pi-eye me-2"></i>View
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeMediaContentModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Export to Excel Modal -->
<div class="modal fade" id="exportExcelModal" tabindex="-1" aria-labelledby="exportExcelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exportExcelModalLabel">
          <i class="pi pi-file-excel me-2"></i>Export Events to Excel
        </h5>
        <button type="button" class="btn-close" (click)="closeExportModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Quick Date Range Selection -->
        <div class="export-quick-range mb-1">
          <label class="form-label fw-semibold mb-1 d-block">Quick Date Range Selection</label>
          <div class="row g-1">
            <div class="col-6 col-sm-4">
              <button type="button" class="btn btn-outline-secondary w-100 btn-sm" (click)="setQuickDateRange('lastWeek')">
                <i class="pi pi-calendar me-1"></i>Last Week
              </button>
            </div>
            <div class="col-6 col-sm-4">
              <button type="button" class="btn btn-outline-secondary w-100 btn-sm" (click)="setQuickDateRange('lastMonth')">
                <i class="pi pi-calendar me-1"></i>Last Month
              </button>
            </div>
            <div class="col-6 col-sm-4">
              <button type="button" class="btn btn-outline-secondary w-100 btn-sm" (click)="setQuickDateRange('last3Months')">
                <i class="pi pi-calendar me-1"></i>Last 3 Months
              </button>
            </div>
            <div class="col-6 col-sm-4">
              <button type="button" class="btn btn-outline-secondary w-100 btn-sm" (click)="setQuickDateRange('last6Months')">
                <i class="pi pi-calendar me-1"></i>Last 6 Months
              </button>
            </div>
            <div class="col-6 col-sm-4">
              <button type="button" class="btn btn-outline-secondary w-100 btn-sm" (click)="setQuickDateRange('lastYear')">
                <i class="pi pi-calendar me-1"></i>Last Year
              </button>
            </div>
            <div class="col-6 col-sm-4">
              <button type="button" class="btn btn-outline-secondary w-100 btn-sm" (click)="setQuickDateRange('last2Years')">
                <i class="pi pi-calendar me-1"></i>Last 2 Years
              </button>
            </div>
            <div class="col-6 col-sm-4">
              <button type="button" class="btn btn-outline-secondary w-100 btn-sm" (click)="setQuickDateRange('all')">
                <i class="pi pi-calendar me-1"></i>All Events
              </button>
            </div>
          </div>
        </div>

        <hr class="my-2">

        <!-- Custom Date Range Selection -->
        <div class="export-custom-range mb-2">
          <label class="form-label fw-semibold mb-1 d-block">Custom Date Range</label>
          <div class="row g-1">
            <div class="col-12 col-sm-6">
              <label for="modalExportStartDate" class="form-label small text-muted">From Date</label>
              <input 
                type="date" 
                class="form-control form-control-sm" 
                id="modalExportStartDate"
                [value]="getDateInputValue(exportStartDate)"
                (change)="onStartDateChange($event)"
                [max]="getDateInputValue(exportEndDate)"
                placeholder="Select start date"
                autocomplete="off">
            </div>
            <div class="col-12 col-sm-6">
              <label for="modalExportEndDate" class="form-label small text-muted">To Date</label>
              <input 
                type="date" 
                class="form-control form-control-sm" 
                id="modalExportEndDate"
                [value]="getDateInputValue(exportEndDate)"
                (change)="onEndDateChange($event)"
                [min]="getDateInputValue(exportStartDate)"
                placeholder="Select end date"
                autocomplete="off">
            </div>
          </div>
        </div>

        <!-- Selected Date Range Display -->
        <div class="alert alert-info mb-0 py-1 px-2">
          <div class="d-flex align-items-center">
            <i class="pi pi-info-circle me-2"></i>
            <div class="flex-grow-1">
              <strong class="d-block small mb-0">Selected Range:</strong>
              <span class="small">
                <span *ngIf="exportStartDate && exportEndDate">
                  {{ exportStartDate | date:'mediumDate' }} to {{ exportEndDate | date:'mediumDate' }}
                </span>
                <span *ngIf="exportStartDate && !exportEndDate">
                  From {{ exportStartDate | date:'mediumDate' }}
                </span>
                <span *ngIf="!exportStartDate && exportEndDate">
                  Until {{ exportEndDate | date:'mediumDate' }}
                </span>
                <span *ngIf="!exportStartDate && !exportEndDate">
                  All Events
                </span>
              </span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" (click)="closeExportModal()">Cancel</button>
        <button type="button" class="btn btn-success btn-sm" (click)="exportEventsToExcel()" [disabled]="exporting || !isExportDateRangeValid()">
          <i class="pi pi-file-excel me-1"></i>
          <span *ngIf="!exporting">Export to Excel</span>
          <span *ngIf="exporting">Exporting...</span>
        </button>
      </div>
    </div>
  </div>
</div>
