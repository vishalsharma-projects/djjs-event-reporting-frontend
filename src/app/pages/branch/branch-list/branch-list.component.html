<div class="page-title-box d-flex align-items-center justify-content-between">
  <h4 class="mb-0">Branches</h4>
  <div>
    <button class="btn btn-primary" (click)="addBranch()">
      <i class="pi pi-plus me-2"></i> Add Branch
    </button>
  </div>
</div>


<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <!-- Search Section -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Search</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-search"></i>
              </span>
              <input
                type="text"
                class="form-control"
                placeholder="Search by Branch, Coordinator, City"
                (input)="onGlobalFilterChange($event)"
              />
            </div>
          </div>
        </div>

        <p-toast></p-toast>

        <p-table
          [value]="branches"
          dataKey="id"
          [expandedRowKeys]="expandedRows"
          (onRowExpand)="onRowExpand($event)"
          (onRowCollapse)="onRowCollapse($event)"
          [rowHover]="true"
          [paginator]="true"
          [rows]="rows"
          [first]="first"
          [rowsPerPageOptions]="rowsPerPageOptions"
          [globalFilterFields]="['branchName','coordinatorName','state','city']"
          (onPageChange)="onPageChange($event)"
          (onSort)="onSort($event)"
          [sortMode]="'single'"
          [tableStyle]="{ 'min-width': '100%' }"
        >
          <!-- Table Header -->
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 5rem"></th>
              <th>
                <div class="d-flex align-items-center justify-content-between">
                  <span>Branch Name</span>
                  <div class="d-flex gap-1">
                    <button
                      class="btn btn-sm btn-link p-0"
                      (click)="toggleColumnPin('branchName')"
                      [class.text-warning]="isColumnPinned('branchName')"
                    >
                      <i class="pi pi-thumbtack"></i>
                    </button>
                    <button
                      class="btn btn-sm btn-link p-0"
                      (click)="showFilter('branchName')"
                    >
                      <i class="pi pi-filter"></i>
                    </button>
                  </div>
                </div>
                <div *ngIf="activeFilter === 'branchName'" class="mt-2">
                  <input
                    type="text"
                    pInputText
                    class="form-control form-control-sm"
                    placeholder="Filter Branch Name"
                    [(ngModel)]="filters['branchName']"
                    (input)="applyFilter()"
                  />
                  <button
                    class="btn btn-sm btn-link p-0 ms-1"
                    (click)="clearFilter('branchName')"
                  >
                    <i class="pi pi-times"></i>
                  </button>
                </div>
              </th>

              <th>
                <span>Coordinator</span>
              </th>

              <th>
                <span>State</span>
              </th>

              <th>
                <span>City</span>
              </th>

              <th>
                <span>Established On</span>
              </th>

              <th>
                <span>Ashram Area</span>
              </th>

              <th>Actions</th>
            </tr>
          </ng-template>

          <!-- Table Body -->
          <ng-template pTemplate="body" let-branch let-expanded="expanded">
            <tr>
              <td>
                <p-button
                  type="button"
                  pRipple
                  [pRowToggler]="branch"
                  [text]="true"
                  severity="secondary"
                  [rounded]="true"
                  [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                ></p-button>
              </td>
              <td>{{ branch.branchName }}</td>
              <td>{{ branch.coordinatorName }}</td>
              <td>{{ branch.state }}</td>
              <td>{{ branch.city }}</td>
              <td>{{ branch.establishedOn | date: 'mediumDate' }}</td>
              <td>{{ branch.ashramArea }}</td>
              <td>
                <div class="d-flex gap-1">
                  <p-button
                    type="button"
                    icon="pi pi-pencil"
                    size="small"
                    severity="secondary"
                    (onClick)="editBranch(branch.id)"
                    pTooltip="Edit Branch"
                    tooltipPosition="top"
                  ></p-button>
                  <p-button
                    type="button"
                    icon="pi pi-trash"
                    size="small"
                    severity="danger"
                    (onClick)="deleteBranch(branch.id)"
                    pTooltip="Delete Branch"
                    tooltipPosition="top"
                  ></p-button>
                </div>
              </td>
            </tr>
          </ng-template>

          <!-- Expanded Row: Members -->
          <ng-template pTemplate="rowexpansion" let-branch>
            <tr>
              <td colspan="8">
                <div class="p-4 expanded-content">
                  <h5>Members of {{ branch.branchName }}</h5>
                  <p-table [value]="branch.members" dataKey="name" [paginator]="true" [rows]="5">
                    <ng-template pTemplate="header">
                      <tr>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Responsibility</th>
                        <th>Age</th>
                        <th>Date of Samarpan</th>
                        <th>Qualification</th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-member>
                      <tr>
                        <td>{{ member.name }}</td>
                        <td>{{ member.role }}</td>
                        <td>{{ member.responsibility }}</td>
                        <td>{{ member.age }}</td>
                        <td>{{ member.dateOfSamarpan }}</td>
                        <td>{{ member.qualification }}</td>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                      <tr>
                        <td colspan="6" class="text-center p-4">
                          <i class="pi pi-inbox text-muted" style="font-size: 2rem"></i>
                          <p class="text-muted mt-2">No members found for this branch.</p>
                        </td>
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
              </td>
            </tr>
          </ng-template>

          <!-- Empty Table Message -->
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="8" class="text-center p-4">
                <i class="pi pi-inbox text-muted" style="font-size: 2rem"></i>
                <p class="text-muted mt-2">No branches found.</p>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
</div>
