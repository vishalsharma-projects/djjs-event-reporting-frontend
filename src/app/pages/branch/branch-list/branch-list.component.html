<div class="row">
  <div class="col-12">
    <div class="page-title-box d-flex align-items-center justify-content-between">
      <h4 class="mb-0">BRANCHES</h4>
      <div class="page-title-right">
        <button class="btn btn-primary" (click)="addBranch()">
          <i class="fas fa-plus me-2"></i>Add Branch
        </button>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-body">

        <!-- Search & Filter -->
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="form-group">
              <label class="form-label">Search</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control" [(ngModel)]="globalFilterValue" placeholder="Search by Branch name or Coordinator"
                       (input)="onGlobalFilterChange($event)">
              </div>
            </div>
          </div>
        </div>

        <p-toast></p-toast>
        <p-table 
          [value]="branches" 
          dataKey="id" 
          [expandedRowKeys]="expandedRows" 
          (onRowExpand)="onRowExpand($event)" 
          (onRowCollapse)="onRowCollapse($event)"
          [rowHover]="true"
          [paginator]="true"
          [rows]="rows"
          [first]="first"
          [rowsPerPageOptions]="rowsPerPageOptions"
          [globalFilterFields]="['branchName', 'coordinatorName', 'state', 'city']"
          (onPageChange)="onPageChange($event)"
          (onSort)="onSort($event)"
          [sortMode]="'single'"
          [tableStyle]="{ 'min-width': '100%' }">

          <!-- Caption -->
          <ng-template pTemplate="caption">
            <div class="d-flex justify-content-end gap-2">
              <p-button label="Expand All" icon="pi pi-plus" text (onClick)="expandAll()" />
              <p-button label="Collapse All" icon="pi pi-minus" text (onClick)="collapseAll()" />
            </div>
          </ng-template>

          <!-- Header -->
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 5rem"></th>
              <th pSortableColumn="branchName">Branch Name
                <p-sortIcon field="branchName"></p-sortIcon>
              </th>
              <th pSortableColumn="coordinatorName">Coordinator
                <p-sortIcon field="coordinatorName"></p-sortIcon>
              </th>
              <th pSortableColumn="state">State
                <p-sortIcon field="state"></p-sortIcon>
              </th>
              <th pSortableColumn="city">City
                <p-sortIcon field="city"></p-sortIcon>
              </th>
              <th pSortableColumn="establishedOn">Established On
                <p-sortIcon field="establishedOn"></p-sortIcon>
              </th>
            </tr>
          </ng-template>

          <!-- Body -->
          <ng-template pTemplate="body" let-branch let-expanded="expanded">
            <tr>
              <td>
                <p-button 
                  type="button" 
                  pRipple 
                  [pRowToggler]="branch" 
                  [text]="true" 
                  severity="secondary"  
                  [rounded]="true" 
                  [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
              </td>
              <td>{{ branch.branchName }}</td>
              <td>{{ branch.coordinatorName }}</td>
              <td>{{ branch.state }}</td>
              <td>{{ branch.city }}</td>
              <td>{{ branch.establishedOn | date:'dd/MM/yyyy' }}</td>
            </tr>
          </ng-template>

          <!-- Row Expansion -->
          <ng-template pTemplate="rowexpansion" let-branch>
            <tr>
              <td colspan="6">
                <div class="p-4">
                  <h5>Members for {{ branch.branchName }}</h5>
                  <p-table [value]="branch.members" dataKey="name" [paginator]="true" [rows]="5" [rowsPerPageOptions]="[5, 10]">
                    <ng-template pTemplate="header">
                      <tr>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Responsibility</th>
                        <th>Age</th>
                        <th>Date of Samarpan</th>
                        <th>Qualification</th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-member>
                      <tr>
                        <td>{{ member.name }}</td>
                        <td>{{ member.role }}</td>
                        <td>{{ member.responsibility }}</td>
                        <td>{{ member.age }}</td>
                        <td>{{ member.dateOfSamarpan }}</td>
                        <td>{{ member.qualification }}</td>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                      <tr>
                        <td colspan="6" class="text-center p-4 text-muted">No members found.</td>
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
              </td>
            </tr>
          </ng-template>

          <!-- Empty Message -->
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6" class="text-center p-4">
                <i class="pi pi-inbox text-muted" style="font-size: 2rem;"></i>
                <p class="text-muted mt-2">No branches found.</p>
              </td>
            </tr>
          </ng-template>
        </p-table>

      </div>
    </div>
  </div>
</div>
