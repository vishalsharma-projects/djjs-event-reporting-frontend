<app-page-title [title]="'Branches'" [breadcrumbItems]="breadCrumbItems"></app-page-title>

<div class="d-flex justify-content-end mb-3">
  <button class="btn btn-primary" (click)="addBranch()">
    <i class="pi pi-plus me-2"></i> Add Branch
  </button>
</div>


<div class="row branch-list-container">
  <div class="col-12 branch-list-content">
    <div class="card">
      <div class="card-body">
        <!-- Search Section -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Search</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-search"></i>
              </span>
              <input
                type="text"
                class="form-control"
                placeholder="Search by Branch, Coordinator, City"
                (input)="onGlobalFilterChange($event)"
              />
            </div>
          </div>
        </div>

        <p-toast></p-toast>

        <p-table
          [value]="branches"
          dataKey="id"
          [expandedRowKeys]="expandedRows"
          (onRowExpand)="onRowExpand($event)"
          (onRowCollapse)="onRowCollapse($event)"
          [rowHover]="true"
          [paginator]="true"
          [rows]="rows"
          [first]="first"
          [rowsPerPageOptions]="rowsPerPageOptions"
          [globalFilterFields]="['branchName','coordinatorName','state','city']"
          (onPageChange)="onPageChange($event)"
          (onSort)="onSort($event)"
          [sortMode]="'single'"
          [tableStyle]="{ 'min-width': '100%' }"
        >
          <!-- Table Header -->
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 5rem"></th>
              <th>
                <div class="d-flex align-items-center justify-content-between">
                  <span>Branch Name</span>
                  <div class="d-flex gap-1">
                    <button
                      class="btn btn-sm btn-link p-0"
                      (click)="toggleColumnPin('branchName')"
                      [class.text-warning]="isColumnPinned('branchName')"
                    >
                      <i class="pi pi-thumbtack"></i>
                    </button>
                    <button
                      class="btn btn-sm btn-link p-0"
                      (click)="showFilter('branchName')"
                    >
                      <i class="pi pi-filter"></i>
                    </button>
                  </div>
                </div>
                <div *ngIf="activeFilter === 'branchName'" class="mt-2">
                  <input
                    type="text"
                    pInputText
                    class="form-control form-control-sm"
                    placeholder="Filter Branch Name"
                    [(ngModel)]="filters['branchName']"
                    (input)="applyFilter()"
                  />
                  <button
                    class="btn btn-sm btn-link p-0 ms-1"
                    (click)="clearFilter('branchName')"
                  >
                    <i class="pi pi-times"></i>
                  </button>
                </div>
              </th>

              <th>
                <span>Coordinator</span>
              </th>

              <th>
                <span>State</span>
              </th>

              <th>
                <span>City</span>
              </th>

              <th>
                <span>Established On</span>
              </th>

              <th>
                <span>Ashram Area</span>
              </th>

              <th>Actions</th>
            </tr>
          </ng-template>

          <!-- Table Body -->
          <ng-template pTemplate="body" let-branch let-expanded="expanded">
            <tr>
              <td>
                <p-button
                  type="button"
                  pRipple
                  [pRowToggler]="branch"
                  [text]="true"
                  severity="secondary"
                  [rounded]="true"
                  [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                ></p-button>
              </td>
              <td>
                <a href="#" class="text-primary text-decoration-none" (click)="viewBranch(branch.id); $event.preventDefault()">
                  {{ branch.branchName }}
                </a>
              </td>
              <td>{{ branch.coordinatorName }}</td>
              <td>{{ branch.state }}</td>
              <td>{{ branch.city }}</td>
              <td>{{ branch.establishedOn | date: 'mediumDate' }}</td>
              <td>{{ branch.ashramArea }}</td>
              <td>
                <div class="action-menu-container" (click)="$event.stopPropagation()">
                  <button
                    class="btn btn-link p-0 action-menu-btn"
                    type="button"
                    (click)="toggleActionMenu(branch.id)">
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                  <div class="action-menu-dropdown" [class.show]="isActionMenuOpen(branch.id)">
                    <a class="dropdown-item" href="#"
                      (click)="editBranch(branch.id); closeActionMenu(); $event.preventDefault()"
                      title="Edit Branch">
                      <i class="pi pi-pencil"></i>
                      <span>Edit</span>
                    </a>
                    <a class="dropdown-item" href="#"
                      (click)="viewBranchMembers(branch.id); closeActionMenu(); $event.preventDefault()"
                      title="View Members">
                      <i class="pi pi-users"></i>
                      <span>View Members</span>
                    </a>
                    <a class="dropdown-item" href="#"
                      (click)="addBranchMember(branch.id); closeActionMenu(); $event.preventDefault()"
                      title="Add Member">
                      <i class="pi pi-user-plus"></i>
                      <span>Add Member</span>
                    </a>
                    <!-- <a class="dropdown-item" href="#"
                      (click)="downloadBranch(branch.id); closeActionMenu(); $event.preventDefault()"
                      title="Download Details">
                      <i class="pi pi-download"></i>
                      <span>Download</span>
                    </a> -->
                    <!-- <a class="dropdown-item" href="#"
                      (click)="openBranchGallery(branch.id); closeActionMenu(); $event.preventDefault()"
                      title="View Gallery">
                      <i class="pi pi-images"></i>
                      <span>Gallery</span>
                    </a> -->
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item text-danger" href="#"
                      (click)="deleteBranch(branch.id); closeActionMenu(); $event.preventDefault()"
                      title="Delete Branch">
                      <i class="pi pi-trash"></i>
                      <span>Delete</span>
                    </a>
                  </div>
                </div>
              </td>
            </tr>
          </ng-template>

          <!-- Expanded Row: Child Branches -->
          <ng-template pTemplate="rowexpansion" let-branch>
            <tr>
              <td colspan="8">
                <div class="p-4 expanded-content">
                  <!-- Child Branches Section -->
                  <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h5 class="mb-0">Child Branches of {{ branch.branchName }} ({{ (branch.children || []).length }})</h5>
                      <button class="btn btn-primary btn-sm" (click)="addChildBranch(branch.id)">
                        <i class="pi pi-plus me-2"></i> Add Child Branch
                      </button>
                    </div>

                    <!-- Loading State for Child Branches -->
                    <div *ngIf="loadingMembers['children_' + branch.id]" class="text-center p-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      <p class="text-muted mt-2">Loading child branches...</p>
                    </div>

                    <!-- Child Branches Table -->
                    <p-table
                      *ngIf="!loadingMembers['children_' + branch.id]"
                      [value]="branch.children || []"
                      dataKey="id"
                      [paginator]="true"
                      [rows]="5"
                      [loading]="loadingMembers['children_' + branch.id]">
                      <ng-template pTemplate="header">
                        <tr>
                          <th>Branch Name</th>
                          <th>Coordinator</th>
                          <th>State</th>
                          <th>City</th>
                          <th>Established On</th>
                          <th>Ashram Area</th>
                          <th>Actions</th>
                        </tr>
                      </ng-template>
                      <ng-template pTemplate="body" let-childBranch>
                        <tr>
                          <td>
                            <a href="#" class="text-primary text-decoration-none" (click)="viewBranch(childBranch.id); $event.preventDefault()">
                              {{ childBranch.branchName }}
                            </a>
                          </td>
                          <td>{{ childBranch.coordinatorName }}</td>
                          <td>{{ childBranch.state }}</td>
                          <td>{{ childBranch.city }}</td>
                          <td>{{ childBranch.establishedOn | date: 'mediumDate' }}</td>
                          <td>{{ childBranch.ashramArea }}</td>
                          <td>
                            <div class="action-menu-container" (click)="$event.stopPropagation()">
                              <button
                                class="btn btn-link p-0 action-menu-btn"
                                type="button"
                                (click)="toggleActionMenu('child_' + childBranch.id)">
                                <i class="pi pi-ellipsis-v"></i>
                              </button>
                              <div class="action-menu-dropdown" [class.show]="isActionMenuOpen('child_' + childBranch.id)">
                                <a class="dropdown-item" href="#"
                                  (click)="editBranch(childBranch.id); closeActionMenu(); $event.preventDefault()"
                                  title="Edit Branch">
                                  <i class="pi pi-pencil"></i>
                                  <span>Edit</span>
                                </a>
                                <a class="dropdown-item" href="#"
                                  (click)="viewBranchMembers(childBranch.id); closeActionMenu(); $event.preventDefault()"
                                  title="View Members">
                                  <i class="pi pi-users"></i>
                                  <span>View Members</span>
                                </a>
                                <a class="dropdown-item" href="#"
                                  (click)="addChildBranchMember(childBranch.id); closeActionMenu(); $event.preventDefault()"
                                  title="Add Member">
                                  <i class="pi pi-user-plus"></i>
                                  <span>Add Member</span>
                                </a>
                                <!-- <a class="dropdown-item" href="#"
                                  (click)="downloadBranch(childBranch.id); closeActionMenu(); $event.preventDefault()"
                                  title="Download Details">
                                  <i class="pi pi-download"></i>
                                  <span>Download</span>
                                </a> -->
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item text-danger" href="#"
                                  (click)="deleteBranch(childBranch.id); closeActionMenu(); $event.preventDefault()"
                                  title="Delete Branch">
                                  <i class="pi pi-trash"></i>
                                  <span>Delete</span>
                                </a>
                              </div>
                            </div>
                          </td>
                        </tr>
                      </ng-template>
                      <ng-template pTemplate="emptymessage">
                        <tr>
                          <td colspan="7" class="text-center p-4">
                            <i class="pi pi-inbox text-muted" style="font-size: 2rem"></i>
                            <p class="text-muted mt-2">No child branches found for this branch.</p>
                          </td>
                        </tr>
                      </ng-template>
                    </p-table>
                  </div>
                </div>
              </td>
            </tr>
          </ng-template>

          <!-- Empty Table Message -->
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="8" class="text-center p-4">
                <i class="pi pi-inbox text-muted" style="font-size: 2rem"></i>
                <p class="text-muted mt-2">No branches found.</p>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
</div>

<!-- Branch Members Drawer - Custom Right-Side Drawer -->
<div class="volunteer-drawer-backdrop"
     *ngIf="isMembersDrawerOpen"
     (click)="closeMembersDrawer()"
     [class.show]="isMembersDrawerOpen">
</div>

<div class="volunteer-drawer"
     *ngIf="isMembersDrawerOpen"
     [class.show]="isMembersDrawerOpen"
     (click)="$event.stopPropagation()">
  <!-- Drawer Header -->
  <div class="drawer-header">
    <h5 id="membersDrawerTitle">Members ({{ selectedBranchMembers?.length || 0 }})</h5>
    <button type="button"
            class="drawer-close"
            (click)="closeMembersDrawer()"
            aria-label="Close">
      âœ•
    </button>
  </div>

  <!-- Drawer Content - Scrollable Content -->
  <div class="drawer-content">
    <div *ngIf="loadingMembers[selectedBranchId || '']" class="text-center p-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted mt-2">Loading members...</p>
    </div>
    <div *ngIf="!loadingMembers[selectedBranchId || ''] && (!selectedBranchMembers || selectedBranchMembers.length === 0)" class="text-center">
      <i class="pi pi-users text-muted" style="font-size: 3rem;"></i>
      <p class="text-muted mt-3">No members found for this branch.</p>
    </div>
    <div *ngIf="!loadingMembers[selectedBranchId || ''] && selectedBranchMembers && selectedBranchMembers.length > 0">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Member Type</th>
            <th>Branch Role</th>
            <th>Responsibility</th>
            <th>Age</th>
            <th>Qualification</th>
            <th>Date of Samarpan</th>
            <th>Date of Birth</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let member of selectedBranchMembers">
            <td data-label="Name">{{ member.name || 'N/A' }}</td>
            <td data-label="Member Type">{{ member.member_type || 'N/A' }}</td>
            <td data-label="Branch Role">{{ member.branch_role || 'N/A' }}</td>
            <td data-label="Responsibility">{{ member.responsibility || 'N/A' }}</td>
            <td data-label="Age">{{ member.age || 'N/A' }}</td>
            <td data-label="Qualification">{{ member.qualification || 'N/A' }}</td>
            <td data-label="Date of Samarpan">{{ member.date_of_samarpan || 'N/A' }}</td>
            <td data-label="Date of Birth">{{ member.date_of_birth || 'N/A' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Drawer Footer -->
  <div class="drawer-footer">
    <button type="button"
            class="btn btn-secondary"
            (click)="closeMembersDrawer()">
      Close
    </button>
  </div>
</div>
