<app-page-title [title]="'All Members'" [breadcrumbItems]="breadCrumbItems"></app-page-title>

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">All Members ({{ members.length }})</h5>
          <button class="btn btn-primary" (click)="openAddMemberModal()">
            <i class="fas fa-plus me-1"></i>Add Member
          </button>
        </div>

        <!-- Search and Filters -->
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <input type="text" class="form-control" placeholder="Search by name, role, responsibility, or branch..."
                [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange()">
            </div>
          </div>
        </div>

        <!-- Filter Buttons -->
        <div class="d-flex flex-wrap gap-2 mb-3">
          <!-- Member Type Filters -->
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm"
              [ngClass]="{'btn-primary': activeMemberType === 'all', 'btn-outline-primary': activeMemberType !== 'all'}"
              (click)="filterByType('all')"
              [style.background]="activeMemberType === 'all' ? 'linear-gradient(135deg, #ff6b35, #f7931e)' : ''"
              [style.border]="activeMemberType === 'all' ? 'none' : '1px solid #ff6b35'"
              [style.color]="activeMemberType === 'all' ? 'white' : '#ff6b35'">
              All Members ({{ members.length }})
            </button>
            <button type="button" class="btn btn-sm"
              [ngClass]="{'btn-primary': activeMemberType === 'preacher', 'btn-outline-primary': activeMemberType !== 'preacher'}"
              (click)="filterByType('preacher')"
              [style.background]="activeMemberType === 'preacher' ? 'linear-gradient(135deg, #ff6b35, #f7931e)' : ''"
              [style.border]="activeMemberType === 'preacher' ? 'none' : '1px solid #ff6b35'"
              [style.color]="activeMemberType === 'preacher' ? 'white' : '#ff6b35'">
              Preacher ({{ preacherCount }})
            </button>
            <button type="button" class="btn btn-sm"
              [ngClass]="{'btn-primary': activeMemberType === 'samarpit', 'btn-outline-primary': activeMemberType !== 'samarpit'}"
              (click)="filterByType('samarpit')"
              [style.background]="activeMemberType === 'samarpit' ? 'linear-gradient(135deg, #ff6b35, #f7931e)' : ''"
              [style.border]="activeMemberType === 'samarpit' ? 'none' : '1px solid #ff6b35'"
              [style.color]="activeMemberType === 'samarpit' ? 'white' : '#ff6b35'">
              Samarpit ({{ samarpitCount }})
            </button>
          </div>

          <!-- Branch Type Filters -->
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm"
              [ngClass]="{'btn-success': activeBranchType === 'all', 'btn-outline-success': activeBranchType !== 'all'}"
              (click)="filterByBranchType('all')">
              All Branches ({{ members.length }})
            </button>
            <button type="button" class="btn btn-sm"
              [ngClass]="{'btn-success': activeBranchType === 'branch', 'btn-outline-success': activeBranchType !== 'branch'}"
              (click)="filterByBranchType('branch')">
              Branch Members ({{ branchCount }})
            </button>
            <button type="button" class="btn btn-sm"
              [ngClass]="{'btn-success': activeBranchType === 'child_branch', 'btn-outline-success': activeBranchType !== 'child_branch'}"
              (click)="filterByBranchType('child_branch')">
              Child Branch Members ({{ childBranchCount }})
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="loading" class="text-center p-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Loading members...</p>
        </div>

        <!-- Members Table -->
        <div *ngIf="!loading" class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Name</th>
                <th>Member Type</th>
                <th>Branch Type</th>
                <th>Branch Name</th>
                <th>Branch Role</th>
                <th>Responsibility</th>
                <th>Age</th>
                <th>Qualification</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let member of filteredMembers">
                <td>{{ member.name }}</td>
                <td>
                  <span class="badge" [ngClass]="member.member_type === 'preacher' ? 'bg-info' : 'bg-success'">
                    {{ member.member_type }}
                  </span>
                </td>
                <td>
                  <span class="badge" [ngClass]="member.branch_type === 'branch' ? 'bg-primary' : 'bg-warning'">
                    {{ member.branch_type === 'branch' ? 'Branch' : 'Child Branch' }}
                  </span>
                </td>
                <td>{{ member.branch_name || member.child_branch_name || 'N/A' }}</td>
                <td>{{ member.branch_role || 'N/A' }}</td>
                <td>{{ member.responsibility || 'N/A' }}</td>
                <td>{{ member.age || 'N/A' }}</td>
                <td>{{ member.qualification || 'N/A' }}</td>
                <td>
                  <div class="d-flex gap-1">
                    <button class="btn btn-sm btn-outline-primary" (click)="openEditMemberModal(member)" title="Edit Member">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" (click)="deleteMember(member)" title="Delete Member">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <tr *ngIf="filteredMembers.length === 0">
                <td colspan="9" class="text-center text-muted p-4">
                  <i class="fas fa-users fa-2x mb-2 d-block"></i>
                  No members found
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<p-toast></p-toast>

<!-- Add Member Modal -->
<div class="modal fade" [class.show]="showAddMemberModal" [style.display]="showAddMemberModal ? 'block' : 'none'" 
     id="addMemberModal" tabindex="-1" role="dialog" aria-labelledby="addMemberModalLabel" aria-hidden="true"
     [attr.aria-hidden]="!showAddMemberModal">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addMemberModalLabel">Add New Member</h5>
        <button type="button" class="btn-close" (click)="closeAddMemberModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="memberForm" (ngSubmit)="onSubmitMember()">
          <!-- Branch Type Selection -->
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label fw-bold">Branch Type <span class="text-danger">*</span></label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" id="branchTypeBranch" formControlName="branch_type" value="branch">
                <label class="btn btn-outline-primary" for="branchTypeBranch">
                  <i class="fas fa-building me-1"></i>Branch
                </label>
                <input type="radio" class="btn-check" id="branchTypeChild" formControlName="branch_type" value="child_branch">
                <label class="btn btn-outline-primary" for="branchTypeChild">
                  <i class="fas fa-sitemap me-1"></i>Child Branch
                </label>
              </div>
            </div>
          </div>

          <!-- Branch Selection -->
          <div class="row mb-3" *ngIf="selectedBranchType === 'branch'">
            <div class="col-12">
              <label class="form-label">Select Branch <span class="text-danger">*</span></label>
              <select class="form-select" formControlName="branch_id"
                [ngClass]="{'is-invalid': memberForm.get('branch_id')?.invalid && memberForm.get('branch_id')?.touched}">
                <option [value]="null">-- Select a Branch --</option>
                <option *ngFor="let branch of branches" [value]="branch.id">
                  {{ branch.name }} ({{ branch.coordinator_name }})
                </option>
              </select>
              <div *ngIf="memberForm.get('branch_id')?.invalid && memberForm.get('branch_id')?.touched" class="invalid-feedback">
                Please select a branch
              </div>
            </div>
          </div>

          <!-- Child Branch Selection -->
          <div class="row mb-3" *ngIf="selectedBranchType === 'child_branch'">
            <div class="col-12">
              <label class="form-label">Select Child Branch <span class="text-danger">*</span></label>
              <select class="form-select" formControlName="child_branch_id"
                [ngClass]="{'is-invalid': memberForm.get('child_branch_id')?.invalid && memberForm.get('child_branch_id')?.touched}">
                <option [value]="null">-- Select a Child Branch --</option>
                <option *ngFor="let childBranch of childBranches" [value]="childBranch.id">
                  {{ childBranch.name }}
                </option>
              </select>
              <div *ngIf="memberForm.get('child_branch_id')?.invalid && memberForm.get('child_branch_id')?.touched" class="invalid-feedback">
                Please select a child branch
              </div>
            </div>
          </div>

          <!-- Member Details -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Member Type <span class="text-danger">*</span></label>
              <select class="form-select" formControlName="member_type"
                [ngClass]="{'is-invalid': memberForm.get('member_type')?.invalid && memberForm.get('member_type')?.touched}">
                <option value="">Select Member Type</option>
                <option value="samarpit">Samarpit Sewadar</option>
                <option value="preacher">Preacher</option>
              </select>
              <div *ngIf="memberForm.get('member_type')?.invalid && memberForm.get('member_type')?.touched" class="invalid-feedback">
                Member type is required
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" formControlName="name" placeholder="Enter member name"
                [ngClass]="{'is-invalid': memberForm.get('name')?.invalid && memberForm.get('name')?.touched}">
              <div *ngIf="memberForm.get('name')?.invalid && memberForm.get('name')?.touched" class="invalid-feedback">
                <span *ngIf="memberForm.get('name')?.errors?.['required']">Name is required</span>
                <span *ngIf="memberForm.get('name')?.errors?.['minlength']">Name must be at least 2 characters</span>
                <span *ngIf="memberForm.get('name')?.errors?.['maxlength']">Name cannot exceed 100 characters</span>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Branch Role <span class="text-danger">*</span></label>
              <select class="form-select" formControlName="branch_role"
                [ngClass]="{'is-invalid': memberForm.get('branch_role')?.invalid && memberForm.get('branch_role')?.touched}">
                <option value="">Select Role</option>
                <option value="Coordinator">Coordinator</option>
                <option value="Volunteer">Volunteer</option>
                <option value="Member">Member</option>
              </select>
              <div *ngIf="memberForm.get('branch_role')?.invalid && memberForm.get('branch_role')?.touched" class="invalid-feedback">
                Branch role is required
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Responsibility</label>
              <select class="form-select" formControlName="responsibility">
                <option value="">Select Responsibility</option>
                <option value="Teaching">Teaching</option>
                <option value="Management">Management</option>
                <option value="Support">Support</option>
                <option value="Preach">Preach</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Age</label>
              <input type="number" class="form-control" formControlName="age" placeholder="Enter age" min="1" max="120"
                [ngClass]="{'is-invalid': memberForm.get('age')?.invalid && memberForm.get('age')?.touched}">
              <div *ngIf="memberForm.get('age')?.invalid && memberForm.get('age')?.touched" class="invalid-feedback">
                Age must be between 1 and 120
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Qualification</label>
              <select class="form-select" formControlName="qualification">
                <option value="">Select Qualification</option>
                <option value="Graduate">Graduate</option>
                <option value="Post Graduate">Post Graduate</option>
                <option value="Diploma">Diploma</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Date of Birth</label>
              <input type="date" class="form-control" formControlName="date_of_birth" [max]="maxDateOfBirth">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Date of Samarpan</label>
              <input type="date" class="form-control" formControlName="date_of_samarpan" 
                [min]="memberForm.get('date_of_birth')?.value || ''">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="closeAddMemberModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="onSubmitMember()" 
          [disabled]="memberForm.invalid || isSubmitting"
          style="background: linear-gradient(135deg, #ff6b35, #f7931e); border: none;">
          <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status"></span>
          {{ isSubmitting ? 'Saving...' : 'Save Member' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div *ngIf="showAddMemberModal" class="modal-backdrop fade show" (click)="closeAddMemberModal()"></div>

<!-- Edit Member Modal -->
<div class="modal fade" [class.show]="showEditMemberModal" [style.display]="showEditMemberModal ? 'block' : 'none'" 
     id="editMemberModal" tabindex="-1" role="dialog" aria-labelledby="editMemberModalLabel" aria-hidden="true"
     [attr.aria-hidden]="!showEditMemberModal">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editMemberModalLabel">Edit Member</h5>
        <button type="button" class="btn-close" (click)="closeEditMemberModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="editMemberForm" (ngSubmit)="updateMember()">
          <!-- Member Info Display -->
          <div class="alert alert-info mb-3" *ngIf="editingMember">
            <strong>Branch:</strong> {{ editingMember.branch_name || editingMember.child_branch_name || 'N/A' }} 
            <span class="badge ms-2" [ngClass]="editingMember.branch_type === 'branch' ? 'bg-primary' : 'bg-warning'">
              {{ editingMember.branch_type === 'branch' ? 'Branch' : 'Child Branch' }}
            </span>
          </div>

          <!-- Member Details -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Member Type <span class="text-danger">*</span></label>
              <select class="form-select" formControlName="member_type"
                [ngClass]="{'is-invalid': editMemberForm.get('member_type')?.invalid && editMemberForm.get('member_type')?.touched}">
                <option value="">Select Member Type</option>
                <option value="samarpit">Samarpit Sewadar</option>
                <option value="preacher">Preacher</option>
              </select>
              <div *ngIf="editMemberForm.get('member_type')?.invalid && editMemberForm.get('member_type')?.touched" class="invalid-feedback">
                Member type is required
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" formControlName="name" placeholder="Enter member name"
                [ngClass]="{'is-invalid': editMemberForm.get('name')?.invalid && editMemberForm.get('name')?.touched}">
              <div *ngIf="editMemberForm.get('name')?.invalid && editMemberForm.get('name')?.touched" class="invalid-feedback">
                <span *ngIf="editMemberForm.get('name')?.errors?.['required']">Name is required</span>
                <span *ngIf="editMemberForm.get('name')?.errors?.['minlength']">Name must be at least 2 characters</span>
                <span *ngIf="editMemberForm.get('name')?.errors?.['maxlength']">Name cannot exceed 100 characters</span>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Branch Role <span class="text-danger">*</span></label>
              <select class="form-select" formControlName="branch_role"
                [ngClass]="{'is-invalid': editMemberForm.get('branch_role')?.invalid && editMemberForm.get('branch_role')?.touched}">
                <option value="">Select Role</option>
                <option value="Coordinator">Coordinator</option>
                <option value="Volunteer">Volunteer</option>
                <option value="Member">Member</option>
              </select>
              <div *ngIf="editMemberForm.get('branch_role')?.invalid && editMemberForm.get('branch_role')?.touched" class="invalid-feedback">
                Branch role is required
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Responsibility</label>
              <select class="form-select" formControlName="responsibility">
                <option value="">Select Responsibility</option>
                <option value="Teaching">Teaching</option>
                <option value="Management">Management</option>
                <option value="Support">Support</option>
                <option value="Preach">Preach</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Age</label>
              <input type="number" class="form-control" formControlName="age" placeholder="Enter age" min="1" max="120"
                [ngClass]="{'is-invalid': editMemberForm.get('age')?.invalid && editMemberForm.get('age')?.touched}">
              <div *ngIf="editMemberForm.get('age')?.invalid && editMemberForm.get('age')?.touched" class="invalid-feedback">
                Age must be between 1 and 120
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Qualification</label>
              <select class="form-select" formControlName="qualification">
                <option value="">Select Qualification</option>
                <option value="Graduate">Graduate</option>
                <option value="Post Graduate">Post Graduate</option>
                <option value="Diploma">Diploma</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Date of Birth</label>
              <input type="date" class="form-control" formControlName="date_of_birth" [max]="maxDateOfBirth">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Date of Samarpan</label>
              <input type="date" class="form-control" formControlName="date_of_samarpan" 
                [min]="editMemberForm.get('date_of_birth')?.value || ''">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="closeEditMemberModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="updateMember()" 
          [disabled]="editMemberForm.invalid || isUpdating"
          style="background: linear-gradient(135deg, #ff6b35, #f7931e); border: none;">
          <span *ngIf="isUpdating" class="spinner-border spinner-border-sm me-2" role="status"></span>
          {{ isUpdating ? 'Updating...' : 'Update Member' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div *ngIf="showEditMemberModal" class="modal-backdrop fade show" (click)="closeEditMemberModal()"></div>

